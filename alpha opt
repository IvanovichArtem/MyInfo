Option Explicit

' Основная процедура: ввод данных, конвертация в числа, калибровка и запись α с учетом границ
Sub AlphaCalibration_Main()
    Dim nMatrices As Long
    Dim i As Long, j As Long, k As Long
    Dim rng As Range, rngMain As Range, rngOut As Range
    Dim tmpArr As Variant, mainArrRaw As Variant
    Dim mainD() As Double
    Dim matrices3D() As Double
    Dim alphaArr() As Double
    Dim r_s_valid As Double, lambda_reg As Double
    Dim delta As Double
    Dim lb As Double, ub As Double
    Dim lbInput As String, ubInput As String
    Dim nRows As Long, nCols As Long
    Dim s As String
    
    ' 1) Ввод количества «валидных» матриц
    nMatrices = Application.InputBox( _
        prompt:="Введите количество валидных матриц:", _
        Title:="Калибровка α", Type:=1)
    If nMatrices < 1 Then Exit Sub
    
    ' 2) Выбор диапазона основной матрицы и конвертация в числа
    Set rngMain = Application.InputBox( _
        prompt:="Выберите диапазон main_matrix:", _
        Title:="Калибровка α", Type:=8)
    If rngMain Is Nothing Then Exit Sub
    rngMain.NumberFormat = "General": rngMain.Value = rngMain.Value
    mainArrRaw = rngMain.Value2
    
    nRows = UBound(mainArrRaw, 1)
    nCols = UBound(mainArrRaw, 2)
    ReDim mainD(1 To nRows, 1 To nCols)
    
    For i = 1 To nRows
        For j = 1 To nCols
            s = CStr(mainArrRaw(i, j))
            s = Replace(s, ",", ".")
            If IsNumeric(s) Then
                mainD(i, j) = CDbl(s)
            Else
                mainD(i, j) = Val(s)
            End If
        Next j
    Next i
    
    ' 3) Подготовка 3D-массива для «валидных» матриц
    ReDim matrices3D(1 To nMatrices, 1 To nRows, 1 To nCols)
    
    ' 4) Считывание каждой «валидной» матрицы и конвертация в числа
    For k = 1 To nMatrices
        Set rng = Application.InputBox( _
            prompt:="Выберите диапазон валидной матрицы №" & k & ":", _
            Title:="Калибровка α", Type:=8)
        If rng Is Nothing Then Exit Sub
        
        rng.NumberFormat = "General": rng.Value = rng.Value
        tmpArr = rng.Value2
        
        If UBound(tmpArr, 1) <> nRows Or UBound(tmpArr, 2) <> nCols Then
            MsgBox "Размер валидной матрицы №" & k & " не совпадает с main_matrix!", _
                   vbCritical, "Ошибка"
            Exit Sub
        End If
        
        For i = 1 To nRows
            For j = 1 To nCols
                s = CStr(tmpArr(i, j))
                s = Replace(s, ",", ".")
                If IsNumeric(s) Then
                    matrices3D(k, i, j) = CDbl(s)
                Else
                    matrices3D(k, i, j) = Val(s)
                End If
            Next j
        Next i
    Next k
    
    ' 5) Ввод r_s_valid и параметра регуляризации
    r_s_valid = Application.InputBox( _
        prompt:="Введите значение r_s_valid:", _
        Title:="Калибровка α", Type:=1)
    delta = r_s_valid - 1
    lambda_reg = 0.01
    
    ' 6) Ввод границ α как строк, затем конвертация
    lbInput = InputBox("Введите нижнюю границу α (по умолчанию -0,2):", "Калибровка α", "-0,2")
    s = Val(Replace(CStr(lbInput), ",", "."))
    If IsNumeric(s) Then
        lb = CDbl(s)
    Else
        MsgBox "Неверная нижняя граница!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    ubInput = InputBox("Введите верхнюю границу α (по умолчанию 0,2):", "Калибровка α", "0,2")
    s = Val(Replace(CStr(ubInput), ",", "."))
    If IsNumeric(s) Then
        ub = CDbl(s)
    Else
        MsgBox "Неверная верхняя граница!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    ' 7) Выбор места для вывода α
    Set rngOut = Application.InputBox( _
        prompt:="Выберите верхний-левый угол для записи α (размер " & nRows & "×" & nCols & "):", _
        Title:="Калибровка α", Type:=8)
    If rngOut Is Nothing Then Exit Sub
    If rngOut.Rows.Count < nRows Or rngOut.Columns.Count < nCols Then
        MsgBox "Выбранный диапазон слишком мал!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    ' 8) Расчёт α с учетом границ
    ReDim alphaArr(1 To nRows, 1 To nCols)
    Dim S_err As Double, S_denom As Double
    S_denom = (delta ^ 2) * nMatrices + lambda_reg
    
    For i = 1 To nRows
        For j = 1 To nCols
            S_err = 0#
            For k = 1 To nMatrices
                S_err = S_err + (matrices3D(k, i, j) - mainD(i, j))
            Next k
            alphaArr(i, j) = (delta * S_err) / S_denom
            ' Применяем границы
            If alphaArr(i, j) < lb Then alphaArr(i, j) = lb
            If alphaArr(i, j) > ub Then alphaArr(i, j) = ub
        Next j
    Next i
    
    ' 9) Запись α в лист
    rngOut.Resize(nRows, nCols).Value = alphaArr
    MsgBox "Калибровка завершена — матрица α записана.", vbInformation, "Готово"
End Sub
