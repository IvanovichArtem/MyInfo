{
  "cells": [
    {
      "cell_type": "markdown",
      "id": "8bc7575b",
      "metadata": {},
      "source": [
        "# Imports\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 17,
      "id": "35f7ef9b",
      "metadata": {},
      "outputs": [],
      "source": [
        "import pandas as pd\n",
        "import numpy as np\n",
        "import os\n",
        "from scipy import stats\n",
        "import matplotlib.pyplot as plt\n",
        "import seaborn as sns\n",
        "import warnings\n",
        "import re\n",
        "import shap\n",
        "from tqdm import tqdm\n",
        "from lightgbm import early_stopping, log_evaluation\n",
        "\n",
        "pd.set_option(\"display.max_columns\", None)\n",
        "pd.set_option(\"display.max_rows\", 100)\n",
        "\n",
        "sns.set(style=\"whitegrid\")\n",
        "\n",
        "import numpy as np\n",
        "import pandas as pd\n",
        "\n",
        "from catboost import CatBoostRegressor, Pool\n",
        "from xgboost import XGBRegressor\n",
        "from lightgbm import LGBMRegressor\n",
        "from sklearn.ensemble import RandomForestRegressor\n",
        "\n",
        "from sklearn.compose import ColumnTransformer\n",
        "from sklearn.preprocessing import OneHotEncoder\n",
        "from sklearn.model_selection import train_test_split\n",
        "from sklearn.metrics import (\n",
        "    mean_squared_error,\n",
        "    mean_absolute_error,\n",
        "    r2_score,\n",
        "    root_mean_squared_error,\n",
        "    mean_absolute_percentage_error,\n",
        ")\n",
        "import pickle\n",
        "\n",
        "warnings.filterwarnings(\"ignore\")"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "ee6bccd8",
      "metadata": {},
      "source": [
        "# Utils\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 2,
      "id": "b0b926a5",
      "metadata": {},
      "outputs": [],
      "source": [
        "from lightgbm.callback import CallbackEnv, EarlyStopException\n",
        "import logging\n",
        "\n",
        "\n",
        "class SimpleGapStopping:\n",
        "    \"\"\"Останавливает обучение сразу при превышении порога разницы\"\"\"\n",
        "\n",
        "    def __init__(self, metric_name=\"rmse\", gap_threshold=3.0, verbose=True):\n",
        "        self.metric_name = metric_name\n",
        "        self.gap_threshold = gap_threshold\n",
        "        self.verbose = verbose\n",
        "        self.order = 20\n",
        "        self.before_iteration = False\n",
        "        self.logger = logging.getLogger(\"LightGBM\")\n",
        "\n",
        "        # Сохраняем предыдущие значения для отслеживания тренда\n",
        "        self.prev_train_metric = None\n",
        "        self.prev_valid_metric = None\n",
        "\n",
        "    def __call__(self, env: CallbackEnv):\n",
        "        if env.evaluation_result_list is None:\n",
        "            return\n",
        "\n",
        "        # Ищем метрики\n",
        "        train_metric, valid_metric = None, None\n",
        "        for result in env.evaluation_result_list:\n",
        "            if len(result) >= 3:\n",
        "                dataset_name, metric_name, metric_value = result[:3]\n",
        "                if metric_name == self.metric_name:\n",
        "                    if \"train\" in dataset_name.lower():\n",
        "                        train_metric = metric_value\n",
        "                    elif \"valid\" in dataset_name.lower():\n",
        "                        valid_metric = metric_value\n",
        "\n",
        "        if train_metric and valid_metric:\n",
        "            gap_ratio = valid_metric / train_metric\n",
        "\n",
        "            # Логируем прогресс каждые 100 итераций\n",
        "            if self.verbose and env.iteration % 100 == 0:\n",
        "                trend = \"\"\n",
        "                if self.prev_train_metric and self.prev_valid_metric:\n",
        "                    train_trend = (\n",
        "                        \"↘\" if train_metric < self.prev_train_metric else \"↗\"\n",
        "                    )\n",
        "                    valid_trend = (\n",
        "                        \"↘\" if valid_metric < self.prev_valid_metric else \"↗\"\n",
        "                    )\n",
        "                    gap_trend = (\n",
        "                        \"↘\"\n",
        "                        if gap_ratio\n",
        "                        < (self.prev_valid_metric / self.prev_train_metric)\n",
        "                        else \"↗\"\n",
        "                    )\n",
        "                    trend = f\" Trend: Train{train_trend} Valid{valid_trend} Gap{gap_trend}\"\n",
        "\n",
        "                print(\n",
        "                    f\"Iter {env.iteration:4d}: {self.metric_name.upper()} - \"\n",
        "                    f\"Train: {train_metric:8.4f}, Valid: {valid_metric:8.4f}, \"\n",
        "                    f\"Gap: {gap_ratio:5.2f}x{trend}\"\n",
        "                )\n",
        "\n",
        "            # Сохраняем текущие значения для следующей итерации\n",
        "            self.prev_train_metric = train_metric\n",
        "            self.prev_valid_metric = valid_metric\n",
        "\n",
        "            # Проверяем условие остановки\n",
        "            if gap_ratio > self.gap_threshold:\n",
        "                if self.verbose:\n",
        "                    print(\n",
        "                        f\"Early stopping triggered at iteration {env.iteration}!\\n\"\n",
        "                        f\"Reason: Gap ratio {gap_ratio:.2f}x exceeds threshold {self.gap_threshold}x\\n\"\n",
        "                        f\"Final metrics - Train {self.metric_name}: {train_metric:.4f}, \"\n",
        "                        f\"Valid {self.metric_name}: {valid_metric:.4f}\"\n",
        "                    )\n",
        "                raise EarlyStopException(\n",
        "                    env.iteration - 1, env.evaluation_result_list\n",
        "                )"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 3,
      "id": "0fc1b020",
      "metadata": {},
      "outputs": [],
      "source": [
        "def add_date_features(\n",
        "    df: pd.DataFrame,\n",
        "    date_col: str = \"deal_date\",\n",
        "    dayfirst: bool = True,\n",
        ") -> pd.DataFrame:\n",
        "    \"\"\"\n",
        "    Преобразует столбец с датой во временной тип и добавляет набор удобных фичей.\n",
        "    Ничего не перезаписывает, создаёт новый столбец <date_col>_dt и фичи.\n",
        "    \"\"\"\n",
        "    out = df.copy()\n",
        "\n",
        "    # Приводим к datetime (бережно к пропускам)\n",
        "    dt = pd.to_datetime(out[date_col], errors=\"coerce\", dayfirst=dayfirst)\n",
        "\n",
        "    # Базовые компоненты\n",
        "    out[\"year\"] = dt.dt.year\n",
        "    out[\"quarter\"] = dt.dt.quarter\n",
        "    out[\"month\"] = dt.dt.month\n",
        "    out[\"day\"] = dt.dt.day\n",
        "    out[\"dayofweek\"] = dt.dt.dayofweek  # 0=Mon..6=Sun\n",
        "    out[\"is_weekend\"] = out[\"dayofweek\"].isin([5, 6]).astype(\"int8\")\n",
        "    out[\"week\"] = dt.dt.isocalendar().week.astype(\"int16\")\n",
        "    out[\"dayofyear\"] = dt.dt.dayofyear\n",
        "    out[\"is_month_start\"] = dt.dt.is_month_start.astype(\"int8\")\n",
        "    out[\"is_month_end\"] = dt.dt.is_month_end.astype(\"int8\")\n",
        "    out[\"is_quarter_start\"] = dt.dt.is_quarter_start.astype(\"int8\")\n",
        "    out[\"is_quarter_end\"] = dt.dt.is_quarter_end.astype(\"int8\")\n",
        "    out[\"is_year_start\"] = dt.dt.is_year_start.astype(\"int8\")\n",
        "    out[\"is_year_end\"] = dt.dt.is_year_end.astype(\"int8\")\n",
        "\n",
        "    # Сезон (зима=1, весна=2, лето=3, осень=4; можно переименовать как нужно)\n",
        "    def month_to_season(m):\n",
        "        if m in (12, 1, 2):\n",
        "            return 1\n",
        "        if m in (3, 4, 5):\n",
        "            return 2\n",
        "        if m in (6, 7, 8):\n",
        "            return 3\n",
        "        return 4\n",
        "\n",
        "    out[\"season\"] = out[\"month\"].map(month_to_season).astype(\"int8\")\n",
        "\n",
        "    # Циклические кодировки — часто помогают моделям\n",
        "    # месяц\n",
        "    out[\"month_sin\"] = np.sin(2 * np.pi * out[\"month\"] / 12)\n",
        "    out[\"month_cos\"] = np.cos(2 * np.pi * out[\"month\"] / 12)\n",
        "    # день недели\n",
        "    out[\"dow_sin\"] = np.sin(2 * np.pi * out[\"dayofweek\"] / 7)\n",
        "    out[\"dow_cos\"] = np.cos(2 * np.pi * out[\"dayofweek\"] / 7)\n",
        "\n",
        "    # Относительные фичи — сколько дней с начала данных / с минимальной даты\n",
        "    origin = dt.min()\n",
        "    out[\"days_since_min\"] = (dt - origin).dt.total_seconds() / (24 * 3600)\n",
        "\n",
        "    return out"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 4,
      "id": "d0b6fafb",
      "metadata": {},
      "outputs": [],
      "source": [
        "# ====== Метрики ======\n",
        "def smape_metric(y_true, y_pred, eps=1e-9):\n",
        "    y_true = np.asarray(y_true)\n",
        "    y_pred = np.asarray(y_pred)\n",
        "    denom = np.abs(y_true) + np.abs(y_pred) + eps\n",
        "    return 100.0 * np.mean(2.0 * np.abs(y_pred - y_true) / denom)\n",
        "\n",
        "\n",
        "def mdape_metric(y_true, y_pred, eps=1e-8):\n",
        "    y_true = np.asarray(y_true)\n",
        "    y_pred = np.asarray(y_pred)\n",
        "    denom = np.where(np.abs(y_true) < eps, eps, np.abs(y_true))\n",
        "    ape = np.abs(y_true - y_pred) / denom\n",
        "    return np.median(ape) * 100.0\n",
        "\n",
        "\n",
        "def compute_metrics(y_true_orig, y_pred_orig):\n",
        "    rmse = root_mean_squared_error(y_true_orig, y_pred_orig)\n",
        "    mae = mean_absolute_error(y_true_orig, y_pred_orig)\n",
        "    mse = mean_squared_error(y_true_orig, y_pred_orig)\n",
        "    r2 = r2_score(y_true_orig, y_pred_orig)\n",
        "    mape = 100.0 * mean_absolute_percentage_error(y_true_orig, y_pred_orig)\n",
        "    mdape = mdape_metric(y_true_orig, y_pred_orig)\n",
        "    smape = smape_metric(y_true_orig, y_pred_orig)\n",
        "    return {\n",
        "        \"rmse\": rmse,\n",
        "        \"mse\": mse,\n",
        "        \"mae\": mae,\n",
        "        \"r2\": r2,\n",
        "        \"mape_%\": mape,\n",
        "        \"median_mape_%\": mdape,\n",
        "        \"smape_%\": smape,\n",
        "    }"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "baa7efbe",
      "metadata": {},
      "source": [
        "# Load\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "b4af10c4",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = pd.read_csv(\"./data/clean_full_df.csv\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "b259f86a",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.columns"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "81c51bab",
      "metadata": {},
      "outputs": [],
      "source": [
        "missing_pct = (\n",
        "    (df.isna().mean()[lambda s: s > 0.5] * 100)\n",
        "    .round(2)\n",
        "    .sort_values(ascending=False)\n",
        ")\n",
        "print((missing_pct.astype(str) + \"%\"))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cc9204bc",
      "metadata": {},
      "outputs": [],
      "source": [
        "drop_columns = [\n",
        "    \"USD\",  # столбцы из 3 пункта обработки\n",
        "    \"BYN\",\n",
        "    \"EUR\",\n",
        "    \"Форма_BYN\",\n",
        "    \"Форма_EUR\",\n",
        "    \"Форма_USD\",\n",
        "    \"Логика извлечения\",\n",
        "    \"sheet_source\",\n",
        "    \"search_param\",\n",
        "    \"Дата\",\n",
        "    \"rules_5\",\n",
        "    \"rules_6\",\n",
        "    \"п/п\",  # ненужные столбцы (лишний, использовались для заполнения других столбцов)\n",
        "]\n",
        "missing_info_drop_columns = list(df.columns[df.isna().mean() > 0.8])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "2b480ce0",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df.shape)\n",
        "df.drop(columns=drop_columns, errors=\"ignore\", inplace=True)\n",
        "print(df.shape)\n",
        "df.drop(columns=missing_info_drop_columns, errors=\"ignore\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cb568bec",
      "metadata": {},
      "outputs": [],
      "source": [
        "missing_pct = (\n",
        "    (df.isna().mean()[lambda s: s >= 0] * 100)\n",
        "    .round(2)\n",
        "    .sort_values(ascending=False)\n",
        ")\n",
        "print((missing_pct.astype(str) + \"%\"))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f1dd898d",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"Цена в долларах США за кв.м\"] = (\n",
        "    df[\"Цена в долларах США\"] / df[\"Общая площадь, кв.м\"]\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4e637cfb",
      "metadata": {},
      "outputs": [],
      "source": [
        "# убираем бел рубли и евро, т.к. предсказывать будем цену за кв. м. в долларах сша\n",
        "df.drop(\n",
        "    columns=[\n",
        "        \"Цена в бел. руб.\",\n",
        "        \"Цена в евро\",\n",
        "        \"Цена в долларах США\",\n",
        "        \"Цена в бел. руб. за кв.м\",\n",
        "        \"Цена в евро за кв.м\",\n",
        "        \"Цена по договору\",\n",
        "        \"Валюта по договору\",\n",
        "    ],\n",
        "    inplace=True,\n",
        "    errors=\"ignore\",\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cf33495d",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.head(2)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "2dedd7af",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.drop(\n",
        "    columns=[\n",
        "        \"Описание назначения\",  # много уникальных значений, строки\n",
        "        \"Наименование\",\n",
        "        \"Дата ввода\",  # повтор столбца Дата сделки\n",
        "        \"Идентификатор сделки\",  # ненужный уникальный идентификатор\n",
        "        \"Адрес\",  # много уникальных значений, инфа уже передана в другие фичи\n",
        "        \"Описание цены\",  # оттуда уже распарсили инфу\n",
        "        \"Тип цены\",  #  всего 1 уникальное значение\n",
        "        \"Инвентарный номер КС\",  # идентификатор\n",
        "        \"Назначение КС\",\n",
        "        \"Описание назначения КС\",\n",
        "        \"Наименование КС\",\n",
        "        \"Составные элементы и принадлежности\",\n",
        "        \"Кадастровый номер ЗУ\",  # еще один идентификатор\n",
        "        \"Описание назначения ЗУ\",\n",
        "        \"Уникальный номер АТЕ\",  # еще один идентификатор\n",
        "    ],\n",
        "    inplace=True,\n",
        "    errors=\"ignore\",\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d95b3a45",
      "metadata": {},
      "outputs": [],
      "source": [
        "def conv_date(x):\n",
        "    if pd.isna(x):\n",
        "        return pd.NaT\n",
        "    s = str(x).strip()\n",
        "    for fmt in (\"%Y-%m-%d %H:%M:%S\", \"%d.%m.%Y\", \"%Y-%m-%d\"):\n",
        "        try:\n",
        "            return pd.to_datetime(s, format=fmt)\n",
        "        except ValueError:\n",
        "            pass\n",
        "    return pd.NaT"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "b291a516",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"Дата сделки\"] = df[\"Дата сделки\"].apply(conv_date)\n",
        "df[\"Дата регистрации договора\"] = df[\"Дата регистрации договора\"].apply(\n",
        "    conv_date\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "71d2af08",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.columns"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "79fd122e",
      "metadata": {},
      "outputs": [],
      "source": [
        "rename_map = {\n",
        "    \"Тип недвижимого имущества\": \"property_type\",\n",
        "    \"Инвентарный номер\": \"inventory_id\",\n",
        "    \"Назначение\": \"purpose\",\n",
        "    \"Общая площадь, кв.м\": \"area_total_m2\",\n",
        "    \"Материал стен\": \"wall_material\",\n",
        "    \"Дата сделки\": \"deal_date\",\n",
        "    \"Дата регистрации договора\": \"contract_reg_date\",\n",
        "    \"Количество объектов в сделке\": \"deal_objects_count\",\n",
        "    \"Цена в долларах США за кв.м\": \"price_usd_per_m2\",\n",
        "    \"Переходящая доля\": \"transferred_share\",\n",
        "    \"Этаж расположения ИП\": \"unit_floor\",\n",
        "    \"Общая площадь КС, кв.м\": \"ks_area_total_m2\",\n",
        "    \"Процент готовности КС\": \"ks_completion_pct\",\n",
        "    \"Количество надземных этажей, шт.\": \"floors_above\",\n",
        "    \"Количество подземных этажей, шт.\": \"floors_below\",\n",
        "    \"Назначение ЗУ\": \"land_use\",\n",
        "    \"Площадь ЗУ, кв.м\": \"land_area_m2\",\n",
        "    \"Маркеры\": \"markers\",\n",
        "    \"Распределение долей до сделки\": \"shares_before\",\n",
        "    \"Распределение долей после сделки\": \"shares_after\",\n",
        "    \"1 Евро (EUR)\": \"eur_rate\",\n",
        "    \"1 Российский рубль (RUB)\": \"rub_rate\",\n",
        "    \"1 Доллар США (USD)\": \"usd_rate\",\n",
        "    \"Name region\": \"region_name\",\n",
        "    \"Name oblast\": \"oblast_name\",\n",
        "}\n",
        "df = df.rename(columns=rename_map)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "cdfd265a",
      "metadata": {},
      "source": [
        "# EDA\n"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "0352564c",
      "metadata": {},
      "source": [
        "## price_usd_per_m2\n",
        "\n",
        "Данный столбец это таргет\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d5d3eeb0",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"price_usd_per_m2\"].isna().sum())\n",
        "df[\"price_usd_per_m2\"].dropna(inplace=True)\n",
        "\n",
        "print(\"inf values count\", (df[\"price_usd_per_m2\"] == np.inf).sum())\n",
        "display(df[df[\"price_usd_per_m2\"] == np.inf].head())\n",
        "df = df[df[\"price_usd_per_m2\"] != np.inf]\n",
        "df[\"price_usd_per_m2\"] = df[\"price_usd_per_m2\"].round(2)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "dd870799",
      "metadata": {},
      "outputs": [],
      "source": [
        "target_col = \"price_usd_per_m2\""
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "df7d2322",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(f\"=== Таргет: {target_col} ===\")\n",
        "print(f\"Всего наблюдений: {df[target_col].size}\")\n",
        "print(f\"Пропусков: {df[target_col].isna().sum()}\")\n",
        "\n",
        "n_le0 = (df[target_col] <= 0).sum()\n",
        "n_eq0 = (df[target_col] == 0).sum()\n",
        "n_neg = (df[target_col] < 0).sum()\n",
        "print(f\"<= 0: {n_le0} | = 0: {n_eq0} | < 0: {n_neg}\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "a4355dfd",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df.shape)\n",
        "df = df[df[target_col] > 0]\n",
        "print(df.shape)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "85c70079",
      "metadata": {},
      "outputs": [],
      "source": [
        "desc = df[target_col].describe(\n",
        "    percentiles=[0.01, 0.05, 0.10, 0.25, 0.50, 0.75, 0.90, 0.95, 0.99]\n",
        ")\n",
        "display(desc.to_frame(\"value\"))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5977f732",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[df[target_col] > 1800][target_col].sort_values()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "68ea0d5c",
      "metadata": {},
      "outputs": [],
      "source": [
        "skew = stats.skew(df[target_col], bias=False)\n",
        "kurt = stats.kurtosis(df[target_col], fisher=True, bias=False)\n",
        "print(f\"Skewness: {skew:.3f} | Kurtosis(Fisher): {kurt:.3f}\")\n",
        "\n",
        "q1, q3 = np.percentile(df[target_col], [25, 75])\n",
        "iqr = q3 - q1\n",
        "low_whisk = q1 - 1.5 * iqr\n",
        "high_whisk = q3 + 1.5 * iqr\n",
        "print(f\"IQR: {iqr:.3f} | границы: [{low_whisk:.3f}, {high_whisk:.3f}]\")\n",
        "print(\n",
        "    f\"Выбросы ниже: {(df[target_col] < low_whisk).sum()} | выше: {(df[target_col] > high_whisk).sum()}\"\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "11986efb",
      "metadata": {},
      "outputs": [],
      "source": [
        "ax = sns.histplot(df[target_col], bins=100, kde=True)\n",
        "ax.set_title(f\"{target_col}: распределение\")\n",
        "ax.set_xlabel(target_col)\n",
        "ax.set_ylabel(\"count\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "3d68d471",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 3.2))\n",
        "sns.boxplot(x=df[target_col], ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col}: boxplot\")\n",
        "axes[0].set_xlabel(target_col)\n",
        "sns.violinplot(x=df[target_col], ax=axes[1], inner=\"quartile\", cut=0)\n",
        "axes[1].set_title(f\"{target_col}: violin\")\n",
        "axes[1].set_xlabel(target_col)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4a018d37",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df.shape, high_whisk, desc[\"1%\"])\n",
        "df = df[~(df[target_col] > high_whisk)]\n",
        "print(\"After delete > high whisk\", df.shape)\n",
        "# df = df[df[target_col] > desc[\"1%\"]]\n",
        "print(df.shape)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "882a7a74",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[target_col].sort_values()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "baeb5e80",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[df[target_col] < 1].shape"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "01ca9e9e",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 5))\n",
        "\n",
        "# Гистограмма до обрезки\n",
        "sns.histplot(df[target_col], bins=100, kde=True, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} до обрезки\")\n",
        "axes[0].set_xlabel(target_col)\n",
        "axes[0].set_ylabel(\"count\")\n",
        "\n",
        "# Гистограмма после обрезки\n",
        "sns.histplot(\n",
        "    df[~(df[target_col] > high_whisk)][target_col],\n",
        "    bins=100,\n",
        "    kde=True,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{target_col} после обрезки\")\n",
        "axes[1].set_xlabel(target_col)\n",
        "axes[1].set_ylabel(\"count\")\n",
        "\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "65459831",
      "metadata": {},
      "outputs": [],
      "source": [
        "ax = sns.histplot(df[target_col], bins=100, kde=True)\n",
        "ax.set_title(f\"{target_col}: распределение\")\n",
        "ax.set_xlabel(target_col)\n",
        "ax.set_ylabel(\"count\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "84401000",
      "metadata": {},
      "outputs": [],
      "source": [
        "s_log = np.log1p(df[target_col])\n",
        "ax = sns.histplot(s_log, bins=60, kde=True)\n",
        "ax.set_title(f\"log1p({target_col}): распределение\")\n",
        "ax.set_xlabel(f\"log1p({target_col})\")\n",
        "ax.set_ylabel(\"count\")\n",
        "plt.tight_layout()\n",
        "plt.show()\n",
        "\n",
        "skew_log = stats.skew(s_log, bias=False)\n",
        "kurt_log = stats.kurtosis(s_log, fisher=True, bias=False)\n",
        "print(f\"После log1p -> Skew: {skew_log:.3f} | Kurtosis: {kurt_log:.3f}\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "ccce5cdd",
      "metadata": {},
      "outputs": [],
      "source": [
        "log_target_col = f\"log1p_{target_col}\"\n",
        "df[log_target_col] = df[target_col].apply(np.log1p)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "8168b090",
      "metadata": {},
      "source": [
        "Сильный правый хвост, попробуем обучить с лог-шкалой и без, а потом проверим метрики\n"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c1",
      "metadata": {},
      "source": [
        "## property_type\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5a705bc8",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.countplot(data=df, x=\"property_type\")\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "3b18a935",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4), sharey=False)\n",
        "sns.boxplot(data=df, x=\"property_type\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(\"target_col by property_type\")\n",
        "\n",
        "sns.boxplot(data=df, x=\"property_type\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(\"log_target_col by property_type\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d9efd836",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.violinplot(data=df, x=\"property_type\", y=target_col, cut=0, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by property_type\")\n",
        "\n",
        "sns.violinplot(data=df, x=\"property_type\", y=log_target_col, cut=0, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by property_type\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cc311fed",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=target_col,\n",
        "    hue=\"property_type\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} | hist by property_type\")\n",
        "\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    hue=\"property_type\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} | hist by property_type\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c3",
      "metadata": {},
      "source": [
        "## purpose\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "880a5d4d",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"purpose\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "62bf8592",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.drop(columns=[\"purpose\"], inplace=True)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c4",
      "metadata": {},
      "source": [
        "## area_total_m2\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "bbedf00b",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"area_total_m2\"].sort_values()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "41d45ada",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.histplot(data=df, x=\"area_total_m2\", bins=50)\n",
        "plt.title(\"Distribution of area_total_m2\")\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5c61f591",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.scatterplot(data=df, x=\"area_total_m2\", y=target_col, ax=axes[0], alpha=0.5)\n",
        "axes[0].set_title(f\"{target_col} vs area_total_m2\")\n",
        "\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"area_total_m2\", y=log_target_col, ax=axes[1], alpha=0.5\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} vs area_total_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "df431b9a",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"area_total_m2\",\n",
        "    y=target_col,\n",
        "    ax=axes[0],\n",
        "    scatter_kws={\"alpha\": 0.4},\n",
        ")\n",
        "axes[0].set_title(f\"Linear trend: {target_col} ~ area_total_m2\")\n",
        "\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"area_total_m2\",\n",
        "    y=log_target_col,\n",
        "    ax=axes[1],\n",
        "    scatter_kws={\"alpha\": 0.4},\n",
        ")\n",
        "axes[1].set_title(f\"Linear trend: {log_target_col} ~ area_total_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "80c4297f",
      "metadata": {},
      "outputs": [],
      "source": [
        "corr_target = df[[\"area_total_m2\", target_col]].corr().iloc[0, 1]\n",
        "corr_log = df[[\"area_total_m2\", log_target_col]].corr().iloc[0, 1]\n",
        "print(\"corr(area_total_m2, target_col)   =\", corr_target)\n",
        "print(\"corr(area_total_m2, log_target_col) =\", corr_log)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0882c08c",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"area_total_m2_bin\"] = pd.qcut(df[\"area_total_m2\"], q=10, duplicates=\"drop\")\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.boxplot(data=df, x=\"area_total_m2_bin\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by area_total_m2 deciles\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=45)\n",
        "\n",
        "sns.boxplot(data=df, x=\"area_total_m2_bin\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by area_total_m2 deciles\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()\n",
        "df.drop(columns=\"area_total_m2_bin\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5783981f",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"log1p_areat_total_m2\"] = df[\"area_total_m2\"].apply(np.log1p)\n",
        "df[\"sqrt_areat_total_m2\"] = df[\"area_total_m2\"].apply(np.sqrt)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8343c186",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.histplot(df[\"log1p_areat_total_m2\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c5",
      "metadata": {},
      "source": [
        "## wall_material\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "e40bb79a",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"wall_material\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "99deeefc",
      "metadata": {},
      "outputs": [],
      "source": [
        "rules = [\n",
        "    (\"кирпич\", r\"кирпич\"),\n",
        "    (\"блок\", r\"блок\"),\n",
        "    (\"железобет\", r\"железобет|сборн.*железобет|ж/б\"),\n",
        "    (\"бетон\", r\"\\bбетон\\b|монолит\"),\n",
        "    (\"дерево\", r\"дерев|брус|бревн|доск\"),\n",
        "    (\"камень\", r\"кам(ень|ни)|природн\"),\n",
        "    (\"металл\", r\"металл\"),\n",
        "    (\"панель\", r\"панел\"),\n",
        "    (\"стекло\", r\"стекл\"),\n",
        "    (\"смешан\", r\"смешан|комбинир|каркас\"),\n",
        "    (\"прочее\", r\"друго|иное|не определ\"),\n",
        "]\n",
        "\n",
        "cats = pd.Series(df[\"wall_material\"].dropna().unique()).astype(str)\n",
        "\n",
        "\n",
        "def _key(s):\n",
        "    t = s.lower()\n",
        "    for i, (_, pat) in enumerate(rules):\n",
        "        if re.search(pat, t):\n",
        "            return (i, t)\n",
        "    return (len(rules), t)  # всё, что не совпало — в конец, по алфавиту\n",
        "\n",
        "\n",
        "order = sorted(cats, key=_key)\n",
        "order, len(order)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "22431809",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(20, 10))\n",
        "sns.boxplot(data=df, y=\"wall_material\", x=target_col, ax=axes[0], order=order)\n",
        "axes[0].set_title(f\"{target_col} by wall_material\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(\n",
        "    data=df, y=\"wall_material\", x=log_target_col, ax=axes[1], order=order\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by wall_material\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "68c9134f",
      "metadata": {},
      "source": [
        "Лучше объединить общие категори в одну (кирпичи в кирпичи и тд)\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d2559acd",
      "metadata": {},
      "outputs": [],
      "source": [
        "EXACT_MAP = {\n",
        "    \"Кирпич\": \"Кирпич\",\n",
        "    \"Кирпич толщиной кладки до 45 см\": \"Кирпич\",\n",
        "    \"Кирпич толщиной кладки более 51 см\": \"Кирпич\",\n",
        "    \"Блоки стеновые\": \"Блоки\",\n",
        "    \"Блоки легкобетонные (силикатные, шлакобетонные, газосиликатные и др.)\": \"Блоки (легкие)\",\n",
        "    \"Блоки бетонные\": \"Блоки\",\n",
        "    \"Крупноблочные из керамзитовых блоков и др.\": \"Блоки (легкие)\",\n",
        "    \"Блоки, камни, кирпичи\": \"Блоки\",\n",
        "    \"Железобетонные изделия\": \"Железобетон\",\n",
        "    \"Железобетон монолитный\": \"Железобетон\",\n",
        "    \"Колонны, диафрагмы жесткости, сборный железобетон\": \"Железобетон\",\n",
        "    \"Каркас ж/б с кирпичным заполнением\": \"Железобетон\",\n",
        "    \"Бетон монолитный\": \"Бетон\",\n",
        "    \"Бетон\": \"Бетон\",\n",
        "    \"Легкий бетон (шлакобетон, аглопоритобетон, опилкобетон и др.)\": \"Бетон (легкий)\",\n",
        "    \"Крупнопанельные\": \"Панели\",\n",
        "    \"Сэндвич-панели\": \"Панели\",\n",
        "    \"Панельные гофрированные (металл с утеплителем)\": \"Панели\",\n",
        "    \"Металл\": \"Металл\",\n",
        "    \"Древесина\": \"Деревянные\",\n",
        "    \"Дерево, бруски, бревна\": \"Деревянные\",\n",
        "    \"Брус\": \"Деревянные\",\n",
        "    \"Бревно\": \"Деревянные\",\n",
        "    \"Доски\": \"Деревянные\",\n",
        "    \"Изделия из древесины\": \"Деревянные\",\n",
        "    \"Камень керамический (мягкие и твердые породы)\": \"Камень\",\n",
        "    \"Камень природный\": \"Камень\",\n",
        "    \"Стекло\": \"Стекло\",\n",
        "    \"Смешанной конструкции\": \"Смешанные/каркасные\",\n",
        "    \"Каркасно-засыпные\": \"Смешанные/каркасные\",\n",
        "    \"Материал стен не определен\": \"Не определено\",\n",
        "    \"Иное\": \"Другое/Иное\",\n",
        "    \"Другое\": \"Другое/Иное\",\n",
        "}\n",
        "\n",
        "\n",
        "def to_clean_category(x):\n",
        "    # сначала пробуем точную мапу, иначе — общая нормализация\n",
        "    return EXACT_MAP.get(str(x).strip())"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "bf6b62a5",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"wall_material\"] = df[\"wall_material\"].apply(to_clean_category)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "429979ea",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.countplot(data=df, y=\"wall_material\")\n",
        "plt.title(\"wall_material_new | class counts\")\n",
        "plt.xticks(rotation=30)\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4a12b824",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(18, 7))\n",
        "sns.boxplot(data=df, x=\"wall_material\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by wall_material\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"wall_material\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by wall_material\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "eb60d4b0",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"wall_material\"].fillna(df[\"wall_material\"].mode()[0], inplace=True)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c6",
      "metadata": {},
      "source": [
        "## deal_date\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "992e2701",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = add_date_features(df, \"deal_date\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f3cf48f7",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"deal_date\"].describe()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "deb5219a",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts = (\n",
        "    df.dropna(subset=[\"deal_date\"])\n",
        "    .assign(cnt=1)\n",
        "    .set_index(\"deal_date\")[\"cnt\"]\n",
        "    .resample(\"MS\")\n",
        "    .sum()\n",
        "    .reset_index()\n",
        "    .rename(columns={\"deal_date\": \"period\", \"cnt\": \"count\"})\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(8, 3))\n",
        "sns.lineplot(data=ts, x=\"period\", y=\"count\", marker=\"o\")\n",
        "plt.title(\"Сделки по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d0415cd0",
      "metadata": {},
      "outputs": [],
      "source": [
        "plt.figure(figsize=(8, 3))\n",
        "sns.histplot(df[\"deal_date\"].dropna().dt.date, bins=100)\n",
        "plt.title(\"Распределение сделок по дням\")\n",
        "plt.xlabel(\"Дата\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "71df36ea",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts_mean = (\n",
        "    df.dropna(subset=[\"deal_date\"])\n",
        "    .set_index(\"deal_date\")\n",
        "    .resample(\"MS\")[[target_col, log_target_col]]\n",
        "    .mean()\n",
        "    .reset_index()\n",
        "    .rename(columns={\"deal_date\": \"period\"})\n",
        ")\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 3.5), sharex=True)\n",
        "sns.lineplot(data=ts_mean, x=\"period\", y=target_col, marker=\"o\", ax=axes[0])\n",
        "axes[0].set_title(f\"Среднее {target_col} по месяцам\")\n",
        "sns.lineplot(data=ts_mean, x=\"period\", y=log_target_col, marker=\"o\", ax=axes[1])\n",
        "axes[1].set_title(f\"Среднее {log_target_col} по месяцам\")\n",
        "for ax in axes:\n",
        "    ax.set_xlabel(\"Месяц\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "0da86e78",
      "metadata": {},
      "source": [
        "Видно, что инфы до 2020 года, очень мало\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "6db08f25",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_dow = df[\"dayofweek\"].value_counts().sort_index().reset_index()\n",
        "by_dow.columns = [\"dayofweek\", \"count\"]\n",
        "\n",
        "plt.figure(figsize=(6, 3))\n",
        "sns.barplot(data=by_dow, x=\"dayofweek\", y=\"count\")\n",
        "plt.title(\"Распределение по дням недели\")\n",
        "plt.xlabel(\"День недели (0=Пн … 6=Вс)\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d67b7d05",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_dow_val = df.dropna(subset=[\"dayofweek\"])[\n",
        "    [\"dayofweek\", target_col, log_target_col]\n",
        "].melt(id_vars=\"dayofweek\", var_name=\"which\", value_name=\"val\")\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(12, 3.5), sharey=False)\n",
        "sns.barplot(\n",
        "    data=by_dow_val.query(\"which == @target_col\"),\n",
        "    x=\"dayofweek\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Mean {target_col} по дням недели\")\n",
        "sns.barplot(\n",
        "    data=by_dow_val.query(\"which == @log_target_col\"),\n",
        "    x=\"dayofweek\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Mean {log_target_col} по дням недели\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "521535df",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_month = df[\"month\"].value_counts().sort_index().reset_index()\n",
        "by_month.columns = [\"month\", \"count\"]\n",
        "\n",
        "plt.figure(figsize=(6, 3))\n",
        "sns.barplot(data=by_month, x=\"month\", y=\"count\")\n",
        "plt.title(\"Распределение по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "35a12c29",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_month_val = df.dropna(subset=[\"month\"])[\n",
        "    [\"month\", target_col, log_target_col]\n",
        "].melt(id_vars=\"month\", var_name=\"which\", value_name=\"val\")\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(12, 3.5), sharex=True)\n",
        "sns.barplot(\n",
        "    data=by_month_val.query(\"which == @target_col\"),\n",
        "    x=\"month\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Mean {target_col} по месяцам\")\n",
        "sns.barplot(\n",
        "    data=by_month_val.query(\"which == @log_target_col\"),\n",
        "    x=\"month\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Mean {log_target_col} по месяцам\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "973cdf52",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_q = df[\"quarter\"].value_counts().sort_index().reset_index()\n",
        "by_q.columns = [\"quarter\", \"count\"]\n",
        "\n",
        "plt.figure(figsize=(5, 3))\n",
        "sns.barplot(data=by_q, x=\"quarter\", y=\"count\")\n",
        "plt.title(\"Распределение по кварталам\")\n",
        "plt.xlabel(\"Квартал\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "51d05582",
      "metadata": {},
      "outputs": [],
      "source": [
        "by_q_val = df.dropna(subset=[\"quarter\"])[\n",
        "    [\"quarter\", target_col, log_target_col]\n",
        "].melt(id_vars=\"quarter\", var_name=\"which\", value_name=\"val\")\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(10, 3.5))\n",
        "sns.barplot(\n",
        "    data=by_q_val.query(\"which == @target_col\"),\n",
        "    x=\"quarter\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Mean {target_col} по кварталам\")\n",
        "sns.barplot(\n",
        "    data=by_q_val.query(\"which == @log_target_col\"),\n",
        "    x=\"quarter\",\n",
        "    y=\"val\",\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Mean {log_target_col} по кварталам\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "b070f28b",
      "metadata": {},
      "outputs": [],
      "source": [
        "pivot = (\n",
        "    df.pivot_table(\n",
        "        index=\"dayofweek\",\n",
        "        columns=\"month\",\n",
        "        values=\"deal_date\",\n",
        "        aggfunc=\"count\",\n",
        "    )\n",
        "    .fillna(0)\n",
        "    .reindex(index=[0, 1, 2, 3, 4, 5, 6], columns=range(1, 13))\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(7, 3.6))\n",
        "ax = sns.heatmap(\n",
        "    pivot, annot=True, fmt=\".0f\", cbar=True, linewidths=0.5, linecolor=\"white\"\n",
        ")\n",
        "ax.set_title(\"Интенсивность: день недели × месяц\")\n",
        "ax.set_xlabel(\"Месяц\")\n",
        "ax.set_ylabel(\"День недели (0=Пн … 6=Вс)\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "84af861f",
      "metadata": {},
      "outputs": [],
      "source": [
        "pivot_t = df.pivot_table(\n",
        "    index=\"dayofweek\", columns=\"month\", values=target_col, aggfunc=\"mean\"\n",
        ").reindex(index=[0, 1, 2, 3, 4, 5, 6], columns=range(1, 13))\n",
        "pivot_l = df.pivot_table(\n",
        "    index=\"dayofweek\", columns=\"month\", values=log_target_col, aggfunc=\"mean\"\n",
        ").reindex(index=[0, 1, 2, 3, 4, 5, 6], columns=range(1, 13))\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.heatmap(\n",
        "    pivot_t,\n",
        "    annot=False,\n",
        "    cbar=True,\n",
        "    linewidths=0.4,\n",
        "    linecolor=\"white\",\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Mean {target_col}: dow × month\")\n",
        "axes[0].set_xlabel(\"Месяц\")\n",
        "axes[0].set_ylabel(\"День недели\")\n",
        "sns.heatmap(\n",
        "    pivot_l,\n",
        "    annot=False,\n",
        "    cbar=True,\n",
        "    linewidths=0.4,\n",
        "    linecolor=\"white\",\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Mean {log_target_col}: dow × month\")\n",
        "axes[1].set_xlabel(\"Месяц\")\n",
        "axes[1].set_ylabel(\"День недели\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "96b0b99f",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 3.5), sharex=True)\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"days_since_min\",\n",
        "    y=target_col,\n",
        "    scatter_kws={\"alpha\": 0.3, \"s\": 15},\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} ~ days_since_min\")\n",
        "axes[0].set_xlabel(\"Дней с минимальной даты\")\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"days_since_min\",\n",
        "    y=log_target_col,\n",
        "    scatter_kws={\"alpha\": 0.3, \"s\": 15},\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} ~ days_since_min\")\n",
        "axes[1].set_xlabel(\"Дней с минимальной даты\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c7",
      "metadata": {},
      "source": [
        "## contract_reg_date\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "65a50f64",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"contract_reg_date\"].isna().sum()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "e1119f3a",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts = (\n",
        "    df.dropna(subset=[\"contract_reg_date\"])\n",
        "    .assign(cnt=1)\n",
        "    .set_index(\"contract_reg_date\")[\"cnt\"]\n",
        "    .resample(\"MS\")\n",
        "    .sum()\n",
        "    .reset_index()\n",
        "    .rename(columns={\"contract_reg_date\": \"period\", \"cnt\": \"count\"})\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(8, 3))\n",
        "sns.lineplot(data=ts, x=\"period\", y=\"count\", marker=\"o\")\n",
        "plt.title(\"contract_reg_date по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4ec34f85",
      "metadata": {},
      "outputs": [],
      "source": [
        "plt.figure(figsize=(8, 3))\n",
        "sns.histplot(df[\"contract_reg_date\"].dropna().dt.date, bins=30)\n",
        "plt.title(\"Распределение contract_reg_date по дням\")\n",
        "plt.xlabel(\"Дата\")\n",
        "plt.ylabel(\"Количество\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d00697b9",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"contract_reg_date\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c8",
      "metadata": {},
      "source": [
        "## deal_objects_count\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "49d060bc",
      "metadata": {},
      "outputs": [],
      "source": [
        "vc = (\n",
        "    df[\"deal_objects_count\"]\n",
        "    .value_counts(dropna=True)\n",
        "    .sort_values(ascending=False)\n",
        "    .reset_index()\n",
        ")\n",
        "vc.columns = [\"deal_objects_count\", \"count\"]\n",
        "\n",
        "plt.figure(figsize=(10, 4))\n",
        "sns.barplot(data=vc.head(30), x=\"deal_objects_count\", y=\"count\")\n",
        "plt.title(\"Топ-30 значений deal_objects_count по частоте\")\n",
        "plt.xticks(rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "df539a83",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"deal_objects_count\",\n",
        "    y=target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} ~ deal_objects_count\")\n",
        "\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"deal_objects_count\",\n",
        "    y=log_target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} ~ deal_objects_count\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8056caf9",
      "metadata": {},
      "outputs": [],
      "source": [
        "top_vals = vc.head(15)[\"deal_objects_count\"].tolist()\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4), sharex=True)\n",
        "sns.barplot(\n",
        "    data=df[df[\"deal_objects_count\"].isin(top_vals)],\n",
        "    x=\"deal_objects_count\",\n",
        "    y=target_col,\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Mean {target_col} для топ-15 deal_objects_count\")\n",
        "sns.barplot(\n",
        "    data=df[df[\"deal_objects_count\"].isin(top_vals)],\n",
        "    x=\"deal_objects_count\",\n",
        "    y=log_target_col,\n",
        "    estimator=\"mean\",\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Mean {log_target_col} для топ-15 deal_objects_count\")\n",
        "for ax in axes:\n",
        "    ax.set_xlabel(\"deal_objects_count\")\n",
        "    ax.tick_params(axis=\"x\", rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c10",
      "metadata": {},
      "source": [
        "## transferred_share\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "da95141b",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"transferred_share\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "37c2a7ba",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"transferred_share\"].fillna(\"NaN\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "9d6fbf4f",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(18, 7))\n",
        "sns.boxplot(data=df, x=\"transferred_share\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by transferred_share\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"transferred_share\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by transferred_share\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c11",
      "metadata": {},
      "source": [
        "## unit_floor\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f4d13fae",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"unit_floor\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f192dab6",
      "metadata": {},
      "outputs": [],
      "source": [
        "# уже есть переменная floor\n",
        "df.drop(columns=[\"unit_floor\"], inplace=True)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c12",
      "metadata": {},
      "source": [
        "## ks_area_total_m2\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "2c8d0dfd",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[[\"area_total_m2\", \"ks_area_total_m2\"]]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "6c28b56f",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.histplot(data=df, x=\"ks_area_total_m2\", bins=60)\n",
        "plt.title(\"Distribution of ks_area_total_m2\")\n",
        "plt.xlabel(\"ks_area_total_m2\")\n",
        "plt.ylabel(\"count\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cf895546",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"ks_area_total_m2\", y=target_col, alpha=0.5, ax=axes[0]\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} vs ks_area_total_m2\")\n",
        "\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"ks_area_total_m2\", y=log_target_col, alpha=0.5, ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} vs ks_area_total_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "19865a84",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"ks_area_total_m2\",\n",
        "    y=target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Linear trend: {target_col} ~ ks_area_total_m2\")\n",
        "\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"ks_area_total_m2\",\n",
        "    y=log_target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Linear trend: {log_target_col} ~ ks_area_total_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "9d2e9305",
      "metadata": {},
      "outputs": [],
      "source": [
        "corr_area = df[[\"ks_area_total_m2\", \"area_total_m2\"]].corr().iloc[0, 1]\n",
        "print(\"Correlation between ares features\", corr_area)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "be040023",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"_ks_area_bin\"] = pd.qcut(df[\"ks_area_total_m2\"], q=10, duplicates=\"drop\")\n",
        "\n",
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.boxplot(data=df, x=\"_ks_area_bin\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by ks_area_total_m2 deciles\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=45)\n",
        "\n",
        "sns.boxplot(data=df, x=\"_ks_area_bin\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by ks_area_total_m2 deciles\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()\n",
        "\n",
        "df.drop(columns=\"_ks_area_bin\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "948f35a1",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"ks_area_total_m2\", y=target_col, alpha=0.4, ax=axes[0]\n",
        ")\n",
        "axes[0].set_xscale(\"log\")\n",
        "axes[0].set_title(f\"{target_col} vs ks_area_total_m2 (log X)\")\n",
        "\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"ks_area_total_m2\", y=log_target_col, alpha=0.4, ax=axes[1]\n",
        ")\n",
        "axes[1].set_xscale(\"log\")\n",
        "axes[1].set_title(f\"{log_target_col} vs ks_area_total_m2 (log X)\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8a257321",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"ks_area_total_m2\"].median())\n",
        "df[\"ks_area_total_m2\"].fillna(df[\"ks_area_total_m2\"].median(), inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5c9efee9",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"log1p_ks_area_total_m2\"] = df[\"ks_area_total_m2\"].apply(np.log1p)\n",
        "df[\"sqrt_ks_area_total_m2\"] = df[\"ks_area_total_m2\"].apply(np.sqrt)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c13",
      "metadata": {},
      "source": [
        "## ks_completion_pct\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "7775451d",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"ks_completion_pct\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c8543b6a",
      "metadata": {},
      "source": [
        "Заменим фичу на булево\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "48c16d04",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"ks_completion_bool\"] = df[\"ks_completion_pct\"].apply(\n",
        "    lambda x: 1 if x == 100 else 0\n",
        ")\n",
        "df[\"ks_completion_bool\"].value_counts()\n",
        "df = df.drop(columns=[\"ks_completion_pct\"])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "2523317d",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(10, 4))\n",
        "sns.boxplot(\n",
        "    data=df, x=\"ks_completion_bool\", y=target_col, order=[0, 1], ax=axes[0]\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} by ks_completion_bool\")\n",
        "\n",
        "sns.boxplot(\n",
        "    data=df, x=\"ks_completion_bool\", y=log_target_col, order=[0, 1], ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by ks_completion_bool\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "fa3292cc",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(10, 4))\n",
        "sns.violinplot(\n",
        "    data=df,\n",
        "    x=\"ks_completion_bool\",\n",
        "    y=target_col,\n",
        "    cut=0,\n",
        "    order=[0, 1],\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} by ks_completion_bool\")\n",
        "\n",
        "sns.violinplot(\n",
        "    data=df,\n",
        "    x=\"ks_completion_bool\",\n",
        "    y=log_target_col,\n",
        "    cut=0,\n",
        "    order=[0, 1],\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by ks_completion_bool\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8ac65138",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=target_col,\n",
        "    hue=\"ks_completion_bool\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col}: hist by ks_completion_bool\")\n",
        "\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    hue=\"ks_completion_bool\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col}: hist by ks_completion_bool\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c14",
      "metadata": {},
      "source": [
        "## floors_above\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "1f095650",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"floors_above\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "eaad33cd",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(18, 7))\n",
        "sns.boxplot(data=df, x=\"floors_above\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by floors_above\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"floors_above\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by floors_above\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c15",
      "metadata": {},
      "source": [
        "## floors_below\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f92895c8",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"floors_below\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "2e3fedac",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(18, 7))\n",
        "sns.boxplot(data=df, x=\"floors_below\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by floors_below\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"floors_below\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by floors_below\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c16",
      "metadata": {},
      "source": [
        "## land_use\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "255e6fd3",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"land_use\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4d80bc7f",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"land_use\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c17",
      "metadata": {},
      "source": [
        "## land_area_m2\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "464ae9ab",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"land_area_m2\"].isna().sum())"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "36e35ee6",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.histplot(data=df, x=\"land_area_m2\", bins=60)\n",
        "plt.title(\"Distribution of land_area_m2\")\n",
        "plt.xlabel(\"land_area_m2\")\n",
        "plt.ylabel(\"count\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "29d634e9",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.scatterplot(data=df, x=\"land_area_m2\", y=target_col, alpha=0.5, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} vs land_area_m2\")\n",
        "\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"land_area_m2\", y=log_target_col, alpha=0.5, ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} vs land_area_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "aad2e821",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"land_area_m2\",\n",
        "    y=target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"Linear trend: {target_col} ~ land_area_m2\")\n",
        "\n",
        "sns.regplot(\n",
        "    data=df,\n",
        "    x=\"land_area_m2\",\n",
        "    y=log_target_col,\n",
        "    scatter_kws={\"alpha\": 0.35, \"s\": 15},\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"Linear trend: {log_target_col} ~ land_area_m2\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "caa49110",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.scatterplot(data=df, x=\"land_area_m2\", y=target_col, alpha=0.4, ax=axes[0])\n",
        "axes[0].set_xscale(\"log\")\n",
        "axes[0].set_title(f\"{target_col} vs land_area_m2 (log X)\")\n",
        "\n",
        "sns.scatterplot(\n",
        "    data=df, x=\"land_area_m2\", y=log_target_col, alpha=0.4, ax=axes[1]\n",
        ")\n",
        "axes[1].set_xscale(\"log\")\n",
        "axes[1].set_title(f\"{log_target_col} vs land_area_m2 (log X)\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "80fa0338",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"land_area_m2\"].median())\n",
        "df[\"land_area_m2\"].fillna(df[\"land_area_m2\"].median(), inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0325223e",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"log1p_land_area_m2\"] = df[\"land_area_m2\"].apply(np.log1p)\n",
        "df[\"sqrt_land_area_m2\"] = df[\"land_area_m2\"].apply(np.sqrt)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c18",
      "metadata": {},
      "source": [
        "## markers\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "950e1c7e",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"markers\"].value_counts()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8e12ce12",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"markers\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c19",
      "metadata": {},
      "source": [
        "## shares_before\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4c185480",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"shares_before\"].value_counts()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0a4f804b",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"shares_before\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c20",
      "metadata": {},
      "source": [
        "## shares_after\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "82634219",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"shares_after\"].value_counts()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "e0b7fd7a",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"shares_after\"])"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c21",
      "metadata": {
        "notebookRunGroups": {
          "groupValue": "1"
        }
      },
      "source": [
        "## eur_rate\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "e95f5e33",
      "metadata": {
        "notebookRunGroups": {
          "groupValue": "2"
        }
      },
      "outputs": [],
      "source": [
        "print(df[\"eur_rate\"].isna().sum())\n",
        "print(df[\"usd_rate\"].isna().sum())\n",
        "print(df[\"rub_rate\"].isna().sum())"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "954f510d",
      "metadata": {},
      "outputs": [],
      "source": [
        "date_key = df[\"deal_date\"].dt.normalize()\n",
        "\n",
        "daily_known = (\n",
        "    df.loc[df[\"eur_rate\"].notna()]\n",
        "    .groupby(date_key[df[\"eur_rate\"].notna()])[\"eur_rate\"]\n",
        "    .first()\n",
        ")\n",
        "df[\"eur_rate\"] = df[\"eur_rate\"].fillna(date_key.map(daily_known))\n",
        "\n",
        "daily_known = (\n",
        "    df.loc[df[\"usd_rate\"].notna()]\n",
        "    .groupby(date_key[df[\"usd_rate\"].notna()])[\"usd_rate\"]\n",
        "    .first()\n",
        ")\n",
        "df[\"usd_rate\"] = df[\"usd_rate\"].fillna(date_key.map(daily_known))\n",
        "\n",
        "daily_known = (\n",
        "    df.loc[df[\"rub_rate\"].notna()]\n",
        "    .groupby(date_key[df[\"rub_rate\"].notna()])[\"rub_rate\"]\n",
        "    .first()\n",
        ")\n",
        "df[\"rub_rate\"] = df[\"rub_rate\"].fillna(date_key.map(daily_known))"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "dacd171c",
      "metadata": {},
      "source": [
        "Есть пропуски ~40 для всех курсов, интерполируем значения с помощью `deal_date`\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "e8275ca1",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts_eur = (\n",
        "    df.dropna(subset=[\"deal_date\", \"eur_rate\"])\n",
        "    .set_index(\"deal_date\")[\"eur_rate\"]\n",
        "    .resample(\"MS\")\n",
        "    .mean()\n",
        "    .reset_index()\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(10, 3.5))\n",
        "sns.lineplot(data=ts_eur, x=\"deal_date\", y=\"eur_rate\", marker=\"o\")\n",
        "plt.title(\"eur_rate по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"eur_rate\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c22",
      "metadata": {},
      "source": [
        "## rub_rate\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "6321dc1f",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df[df[\"rub_rate\"].notna()]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "21564923",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts_eur = (\n",
        "    df.dropna(subset=[\"deal_date\", \"rub_rate\"])\n",
        "    .set_index(\"deal_date\")[\"rub_rate\"]\n",
        "    .resample(\"MS\")\n",
        "    .mean()\n",
        "    .reset_index()\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(10, 3.5))\n",
        "sns.lineplot(data=ts_eur, x=\"deal_date\", y=\"rub_rate\", marker=\"o\")\n",
        "plt.title(\"rub_rate по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"rub_rate\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c23",
      "metadata": {},
      "source": [
        "## usd_rate\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "b1c92fef",
      "metadata": {},
      "outputs": [],
      "source": [
        "ts_eur = (\n",
        "    df.dropna(subset=[\"deal_date\", \"usd_rate\"])\n",
        "    .set_index(\"deal_date\")[\"usd_rate\"]\n",
        "    .resample(\"MS\")\n",
        "    .mean()\n",
        "    .reset_index()\n",
        ")\n",
        "\n",
        "plt.figure(figsize=(10, 3.5))\n",
        "sns.lineplot(data=ts_eur, x=\"deal_date\", y=\"usd_rate\", marker=\"o\")\n",
        "plt.title(\"usd_rate по месяцам\")\n",
        "plt.xlabel(\"Месяц\")\n",
        "plt.ylabel(\"usd_rate\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c24",
      "metadata": {},
      "source": [
        "## floor\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8ee084a6",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"floor\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "c51c4f0d",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(18, 7))\n",
        "sns.boxplot(data=df, x=\"floor\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by floor\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"floor\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by floor\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c25",
      "metadata": {},
      "source": [
        "## category\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "9a2004d5",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"category\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "795feb47",
      "metadata": {},
      "outputs": [],
      "source": [
        "order_freq = df[\"category\"].value_counts().index.tolist()\n",
        "\n",
        "plt.figure(figsize=(10, 4))\n",
        "sns.countplot(data=df, x=\"category\", order=order_freq)\n",
        "plt.title(\"category | class counts\")\n",
        "plt.xticks(rotation=45, ha=\"right\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "a5650c82",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 5))\n",
        "sns.boxplot(data=df, x=\"category\", y=target_col, order=order_freq, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by category\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=45)\n",
        "\n",
        "sns.boxplot(\n",
        "    data=df, x=\"category\", y=log_target_col, order=order_freq, ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by category\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "24cb463a",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 5))\n",
        "sns.violinplot(\n",
        "    data=df, x=\"category\", y=target_col, cut=0, order=order_freq, ax=axes[0]\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} by category\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=45)\n",
        "\n",
        "sns.violinplot(\n",
        "    data=df, x=\"category\", y=log_target_col, cut=0, order=order_freq, ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by category\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=45)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4e345814",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.displot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    hue=\"category\",\n",
        "    kind=\"hist\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        ")\n",
        "plt.suptitle(f\"Hist {log_target_col} by category\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "7a3b6402",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"category\"].fillna(\"undef\", inplace=True)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c26",
      "metadata": {},
      "source": [
        "## for_clusters_gr\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0613eec6",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"for_clusters_gr\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "6cca7bb2",
      "metadata": {},
      "outputs": [],
      "source": [
        "order = df[\"for_clusters_gr\"].value_counts().index.tolist()\n",
        "\n",
        "# распределение классов\n",
        "plt.figure(figsize=(6, 3))\n",
        "sns.countplot(data=df, x=\"for_clusters_gr\", order=order)\n",
        "plt.title(\"for_clusters_gr | class counts\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "7971de98",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.boxplot(data=df, x=\"for_clusters_gr\", y=target_col, order=order, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by for_clusters_gr\")\n",
        "\n",
        "sns.boxplot(\n",
        "    data=df, x=\"for_clusters_gr\", y=log_target_col, order=order, ax=axes[1]\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by for_clusters_gr\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "7e6f852c",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.violinplot(\n",
        "    data=df, x=\"for_clusters_gr\", y=target_col, cut=0, order=order, ax=axes[0]\n",
        ")\n",
        "axes[0].set_title(f\"{target_col} by for_clusters_gr\")\n",
        "\n",
        "sns.violinplot(\n",
        "    data=df,\n",
        "    x=\"for_clusters_gr\",\n",
        "    y=log_target_col,\n",
        "    cut=0,\n",
        "    order=order,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col} by for_clusters_gr\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cd093ffb",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=target_col,\n",
        "    hue=\"for_clusters_gr\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col}: hist by for_clusters_gr\")\n",
        "\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    hue=\"for_clusters_gr\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col}: hist by for_clusters_gr\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c27",
      "metadata": {},
      "source": [
        "## Name NP\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0899f78f",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"Name NP\"].isna().sum())\n",
        "df[\"Name NP\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c28",
      "metadata": {},
      "source": [
        "## region_name\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8dc917a2",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(df[\"region_name\"].isna().sum())\n",
        "df[\"region_name\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c29",
      "metadata": {},
      "source": [
        "## oblast_name\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "1337105b",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"oblast_name\"].value_counts(dropna=False)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "60d10d6c",
      "metadata": {},
      "outputs": [],
      "source": [
        "plt.figure(figsize=(7, 3))\n",
        "sns.countplot(data=df, x=\"oblast_name\")\n",
        "plt.title(\"oblast_name | counts\")\n",
        "plt.xticks(rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d7bf3a93",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(12, 4))\n",
        "sns.boxplot(data=df, x=\"oblast_name\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by oblast_name\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"oblast_name\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by oblast_name\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "14471661",
      "metadata": {},
      "outputs": [],
      "source": [
        "g1 = sns.displot(\n",
        "    data=df,\n",
        "    x=target_col,\n",
        "    col=\"oblast_name\",\n",
        "    col_wrap=4,\n",
        "    bins=40,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        ")\n",
        "g1.fig.subplots_adjust(top=0.9)\n",
        "g1.fig.suptitle(f\"Hist {target_col} by oblast_name\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "9ab4b9d2",
      "metadata": {},
      "outputs": [],
      "source": [
        "g2 = sns.displot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    col=\"oblast_name\",\n",
        "    col_wrap=4,\n",
        "    bins=40,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        ")\n",
        "g2.fig.subplots_adjust(top=0.9)\n",
        "g2.fig.suptitle(f\"Hist {log_target_col} by oblast_name\")"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c30",
      "metadata": {},
      "source": [
        "## cluster_score\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "69ee253d",
      "metadata": {},
      "outputs": [],
      "source": [
        "df[\"_cs_is_neg\"] = (df[\"cluster_score\"] == -1).astype(\"int8\")\n",
        "df[\"_cs_pos\"] = df[\"cluster_score\"].where(\n",
        "    df[\"cluster_score\"] >= 0\n",
        ")  # только валидные (>=0)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "110a05f1",
      "metadata": {},
      "outputs": [],
      "source": [
        "plt.figure(figsize=(6, 3))\n",
        "sns.countplot(x=df[\"_cs_is_neg\"].map({0: \">=0\", 1: \"-1 (neg)\"}))\n",
        "plt.title(\"cluster_score: доля -1 vs >=0\")\n",
        "plt.xlabel(\"\")\n",
        "plt.tight_layout()\n",
        "plt.show()\n",
        "\n",
        "plt.figure(figsize=(8, 3))\n",
        "sns.histplot(df[\"_cs_pos\"].dropna(), bins=60)\n",
        "plt.title(\"cluster_score (>=0), full scale\")\n",
        "plt.xlabel(\"cluster_score\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "67015a6a",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4c7ccad3",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(10, 4))\n",
        "sns.boxplot(data=df, x=\"_cs_is_neg\", y=target_col, ax=axes[0])\n",
        "axes[0].set_xticklabels([\">=0\", \"-1 (neg)\"])\n",
        "axes[0].set_title(f\"{target_col} by cluster_score group\")\n",
        "\n",
        "sns.boxplot(data=df, x=\"_cs_is_neg\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_xticklabels([\">=0\", \"-1 (neg)\"])\n",
        "axes[1].set_title(f\"{log_target_col} by cluster_score group\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "6ed44faa",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.drop(columns=[\"_cs_pos\"], inplace=True)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "c31",
      "metadata": {},
      "source": [
        "## cluster\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "3b00324e",
      "metadata": {},
      "outputs": [],
      "source": [
        "plt.figure(figsize=(8, 3))\n",
        "sns.countplot(data=df, x=\"cluster\")\n",
        "plt.title(\"cluster | counts\")\n",
        "plt.xticks(rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "c678d98c",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.boxplot(data=df, x=\"cluster\", y=target_col, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by cluster\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.boxplot(data=df, x=\"cluster\", y=log_target_col, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by cluster\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "593d0a27",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.violinplot(data=df, x=\"cluster\", y=target_col, cut=0, ax=axes[0])\n",
        "axes[0].set_title(f\"{target_col} by cluster\")\n",
        "axes[0].tick_params(axis=\"x\", rotation=30)\n",
        "\n",
        "sns.violinplot(data=df, x=\"cluster\", y=log_target_col, cut=0, ax=axes[1])\n",
        "axes[1].set_title(f\"{log_target_col} by cluster\")\n",
        "axes[1].tick_params(axis=\"x\", rotation=30)\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d54cb8e3",
      "metadata": {},
      "outputs": [],
      "source": [
        "fig, axes = plt.subplots(1, 2, figsize=(14, 4))\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=target_col,\n",
        "    hue=\"cluster\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[0],\n",
        ")\n",
        "axes[0].set_title(f\"{target_col}: hist by cluster\")\n",
        "\n",
        "sns.histplot(\n",
        "    data=df,\n",
        "    x=log_target_col,\n",
        "    hue=\"cluster\",\n",
        "    bins=50,\n",
        "    element=\"step\",\n",
        "    stat=\"density\",\n",
        "    common_norm=False,\n",
        "    ax=axes[1],\n",
        ")\n",
        "axes[1].set_title(f\"{log_target_col}: hist by cluster\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "8bec3002",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.to_csv(\"./data/after_eda.csv\", index=False)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "dc9629bd",
      "metadata": {},
      "source": [
        "# Model\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "87996470",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = pd.read_csv(\"./data/after_eda.csv\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f7b5a629",
      "metadata": {},
      "outputs": [],
      "source": [
        "from lightgbm import LGBMRegressor\n",
        "from sklearn.model_selection import train_test_split\n",
        "from sklearn.metrics import (\n",
        "    mean_squared_error,\n",
        "    mean_absolute_error,\n",
        "    root_mean_squared_error,\n",
        "    mean_absolute_percentage_error,\n",
        ")\n",
        "\n",
        "\n",
        "# ====== Метрики ======\n",
        "def smape_metric(y_true, y_pred, eps=1e-9):\n",
        "    y_true = np.asarray(y_true)\n",
        "    y_pred = np.asarray(y_pred)\n",
        "    denom = np.abs(y_true) + np.abs(y_pred) + eps\n",
        "    return 100.0 * np.mean(2.0 * np.abs(y_pred - y_true) / denom)\n",
        "\n",
        "\n",
        "def mdape_metric(y_true, y_pred, eps=1e-8):\n",
        "    y_true = np.asarray(y_true)\n",
        "    y_pred = np.asarray(y_pred)\n",
        "    denom = np.where(np.abs(y_true) < eps, eps, np.abs(y_true))\n",
        "    ape = np.abs(y_true - y_pred) / denom\n",
        "    return np.median(ape) * 100.0\n",
        "\n",
        "\n",
        "def compute_metrics(y_true_orig, y_pred_orig):\n",
        "    rmse = root_mean_squared_error(y_true_orig, y_pred_orig)\n",
        "    mae = mean_absolute_error(y_true_orig, y_pred_orig)\n",
        "    mse = mean_squared_error(y_true_orig, y_pred_orig)\n",
        "    mape = 100.0 * mean_absolute_percentage_error(y_true_orig, y_pred_orig)\n",
        "    mdape = mdape_metric(y_true_orig, y_pred_orig)\n",
        "    smape = smape_metric(y_true_orig, y_pred_orig)\n",
        "    return {\n",
        "        \"rmse\": rmse,\n",
        "        \"mse\": mse,\n",
        "        \"mae\": mae,\n",
        "        \"mape_%\": mape,\n",
        "        \"median_mape_%\": mdape,\n",
        "        \"smape_%\": smape,\n",
        "    }"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "91024e34",
      "metadata": {},
      "outputs": [],
      "source": [
        "SHUFFLE = True\n",
        "TEST_SIZE = 0.25\n",
        "RANDOM_STATE = 42"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "655f9ac8",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.sort_values(\"deal_date\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "53c63d05",
      "metadata": {},
      "outputs": [],
      "source": [
        "TARGET = \"price_usd_per_m2\"\n",
        "TARGET_LOG = \"log1p_price_usd_per_m2\""
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4a2dedcb",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.drop(columns=[\"inventory_id\", \"deal_date\"], inplace=True)\n",
        "\n",
        "Y = df[TARGET]\n",
        "X = df.drop(columns=[TARGET, TARGET_LOG])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "13bb92c7",
      "metadata": {},
      "outputs": [],
      "source": [
        "cat_cols = [\n",
        "    \"property_type\",\n",
        "    \"wall_material\",\n",
        "    \"transferred_share\",\n",
        "    \"category\",\n",
        "    \"for_clusters_gr\",\n",
        "    \"Name NP\",\n",
        "    \"region_name\",\n",
        "    \"oblast_name\",\n",
        "    \"cluster\",\n",
        "]\n",
        "cat_idx = [X.columns.get_loc(c) for c in cat_cols]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "bdb2bd71",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train, X_valid, y_train, y_valid = train_test_split(\n",
        "    X,\n",
        "    Y,\n",
        "    test_size=TEST_SIZE,\n",
        "    random_state=RANDOM_STATE,\n",
        "    shuffle=SHUFFLE,\n",
        "    # stratify=X[\"bin_drop\"],\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "0aae22de",
      "metadata": {},
      "outputs": [],
      "source": [
        "sns.histplot(y_train)\n",
        "sns.histplot(y_valid)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "359334b3",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train[cat_cols] = X_train[cat_cols].astype(\"category\")\n",
        "X_valid[cat_cols] = X_valid[cat_cols].astype(\"category\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f08c4955",
      "metadata": {},
      "outputs": [],
      "source": [
        "best_params = {\n",
        "    \"boosting_type\": \"gbdt\",\n",
        "    \"colsample_bytree\": 0.7,  # Увеличение рандомизации признаков\n",
        "    \"importance_type\": \"split\",\n",
        "    \"learning_rate\": 0.01,  # Уменьшение темпа обучения\n",
        "    \"max_depth\": 5,  # Уменьшение глубины\n",
        "    \"min_child_samples\": 11,\n",
        "    \"min_child_weight\": 8.0,  # Увеличение веса листа\n",
        "    \"min_data_in_leaf\": 15,  # Увеличение мин. данных в листе (сильная регуляризация)\n",
        "    \"min_split_gain\": 0.01768422649000459,\n",
        "    \"n_estimators\": 30000,  # Увеличим, т.к. уменьшили learning_rate\n",
        "    \"n_jobs\": 0,\n",
        "    \"num_leaves\": 31,  # Уменьшим до стандартного значения num_leaves\n",
        "    \"objective\": \"regression\",\n",
        "    \"random_state\": 42,\n",
        "    \"reg_alpha\": 2.3326872626500275,\n",
        "    \"reg_lambda\": 2,\n",
        "    \"subsample\": 0.75,  # Уменьшение доли строк\n",
        "    \"max_bin\": 249,\n",
        "    \"extra_trees\": False,\n",
        "    \"verbose\": -1,\n",
        "}"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "9ecfc69f",
      "metadata": {},
      "outputs": [],
      "source": [
        "lgbm_model = LGBMRegressor(**best_params)\n",
        "differential_stopping = SimpleGapStopping(metric_name=\"rmse\", gap_threshold=1.3)\n",
        "\n",
        "lgbm_model.fit(\n",
        "    X_train,\n",
        "    y_train,\n",
        "    eval_set=[(X_train, y_train), (X_valid, y_valid)],\n",
        "    eval_metric=[\"rmse\", \"mape\", \"mae\"],\n",
        "    callbacks=[\n",
        "        early_stopping(stopping_rounds=300),\n",
        "        differential_stopping,\n",
        "        log_evaluation(200),\n",
        "    ],\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "a44fa704",
      "metadata": {},
      "outputs": [],
      "source": [
        "print(\n",
        "    \"Train\",\n",
        "    compute_metrics((y_train), (lgbm_model.predict(X_train))),\n",
        ")\n",
        "print(\n",
        "    \"Valid\",\n",
        "    compute_metrics(y_valid, (lgbm_model.predict(X_valid))),\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5f6ac76a",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train.shape[0], X_valid.shape[0]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "aa968904",
      "metadata": {},
      "outputs": [],
      "source": [
        "explainer = shap.Explainer(\n",
        "    lgbm_model, feature_perturbation=\"tree_path_dependent\"\n",
        ")\n",
        "shap_values = explainer(X_valid)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "d8488187",
      "metadata": {},
      "outputs": [],
      "source": [
        "shap.summary_plot(shap_values, X_valid, max_display=X_valid.shape[1])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "4002eab9",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "04251186",
      "metadata": {},
      "outputs": [],
      "source": [
        "import pickle\n",
        "\n",
        "\n",
        "# with open(\"./models/lgbm_model_base.pkl\", \"wb+\") as f:\n",
        "#     pickle.dump(lgbm_model, f)"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "4c0d86c9",
      "metadata": {},
      "source": [
        "# Model TargetLog\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 22,
      "id": "7da0aa64",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = pd.read_csv(\"./data/after_eda.csv\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 23,
      "id": "c13d8803",
      "metadata": {},
      "outputs": [],
      "source": [
        "SHUFFLE = True\n",
        "TEST_SIZE = 0.25\n",
        "RANDOM_STATE = 42"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 24,
      "id": "07fa1882",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.sort_values(\"deal_date\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 25,
      "id": "48a10b88",
      "metadata": {},
      "outputs": [],
      "source": [
        "TARGET = \"price_usd_per_m2\"\n",
        "TARGET_LOG = \"log1p_price_usd_per_m2\""
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 26,
      "id": "6926c007",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.drop(columns=[\"inventory_id\", \"deal_date\"], inplace=True)\n",
        "\n",
        "Y = df[TARGET_LOG]\n",
        "X = df.drop(columns=[TARGET, TARGET_LOG])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 27,
      "id": "43f473e5",
      "metadata": {},
      "outputs": [],
      "source": [
        "cat_cols = [\n",
        "    \"property_type\",\n",
        "    \"wall_material\",\n",
        "    \"transferred_share\",\n",
        "    \"category\",\n",
        "    \"for_clusters_gr\",\n",
        "    \"Name NP\",\n",
        "    \"region_name\",\n",
        "    \"oblast_name\",\n",
        "    \"cluster\",\n",
        "]\n",
        "cat_idx = [X.columns.get_loc(c) for c in cat_cols]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 28,
      "id": "3ace75af",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train, X_valid, y_train, y_valid = train_test_split(\n",
        "    X, Y, test_size=TEST_SIZE, random_state=RANDOM_STATE, shuffle=SHUFFLE\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 29,
      "id": "298a8f8a",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train[cat_cols] = X_train[cat_cols].astype(\"category\")\n",
        "X_valid[cat_cols] = X_valid[cat_cols].astype(\"category\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 30,
      "id": "e632d49f",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "<Axes: xlabel='log1p_price_usd_per_m2', ylabel='Count'>"
            ]
          },
          "execution_count": 30,
          "metadata": {},
          "output_type": "execute_result"
        },
        {
          "data": {
            "image/png": "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tDCwGoDjw9HFF18sq1evlmnTpsnvf//7GotDjhgxQq6++upolhEAGFgNwPlT+adOnSpXXHGFWedo37594nK55IwzzpAePXpEv5QAAABOHHO0bt06c2mQ5557zvysQUhbkS655BJ54okn5LbbbpONGzc2VVkBAACcE462bNliLjirY4u6d+9e47HU1FSZOHGi7N271wQlZqsBAICED0ezZs2S1q1byyuvvCJnnXVWjccyMzPl8ssvlz//+c+Snp5uVsgGAABI6HD0ySefyLhx48w11IJp166dGYf08ccfR6t8AAAgDuVkpUa8DEesl+8IeUB2UVGRdOvWrcHt8vLypLCwsLHlAgAAcSwzLSWiZTja5WbJRWfmSVyEI20x0oDUEL0AbatWrRpbLgAAkITLcMRVt9rAgQPl5ZdfbnC7JUuWBL20CAAAQMKEozFjxsiKFSvMytjl5eUB1z56+OGH5cMPP5RRo0ZFu5wAAADO6lbr06eP3HXXXfLggw/Kq6++KkOGDJEjjjhCqqurZevWrSY4aZfazTffLEOHDm3aUgMAADhhhWxtEerdu7fMnj1b3n33XX8LUnZ2tpx00klmplq/fv2aqqwAAADOu3zIcccdZ77U7t27JSUlRVq2bNkUZQMAAIiPa6tZ6lvzCAAAIOGvrQYAAJDoGtVyBAAA4lOrnDTJzkitd5tqn1fatMo037drffA2mOKyStl3oEISAeEIAIAkDEa3XTxAUlNDjwEXFfSq9/HKyip59E9fJERAIhwBaHIul8tcK0kvJQAg9rTFSIPRutfnScmu7UG38/n0MiBuOSw3S4p2l0hFlTfgdlltO0iv8y41xyUcIepSU1PNBwmQaCK5xpLK65IrBYO7Nlm5gGSmwah4+5Z6w5FkeKTSlyMlRQekvLJakgHhyEE0FOUffbSkeDxh78t/5UjUayw1NM4BAKKNcOQwGoz+tHSt7NpbFldXMAYAIFEQjhyoaE+JbN9VGutiAACQlOJqnaONGzfKgAED5OWXX/bft2bNGhk9erT0799fTjvtNJk3b16Nfbxer0yfPt1c7023ueqqq2Tz5s0xKD0AAIgHcROOKisrZcKECVJS8uNgTr3Q7dixY6VLly6yePFiuf7662XatGnme8uMGTNk/vz5MmXKFFmwYIEJS+PGjZOKivgfTQ8AAJI4HD355JOSk5NT475F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dEl0SbMIpJPNmDFD5s+fLw899JBZtVtX7x43bpy8/vrrZnXvRPXiiy/K448/Lscff7wkuttuu0127Nghjz76qLRt21aef/55ufLKK+WVV16RI488UhLN9ddfb0L/rFmzJDs7W5544gm5/PLLZenSpRFd7DleVFZWyoQJE6SkpEQS3dq1ayU9PV3eeeedGlc5b9GihSSiV199VSZNmiR33323+Uf2jTfeML/X+jc7ES9GPmDAAPnoo49q3Pfll1/KjTfeKNddd50kOlqOYqyiokLmzJljVvAeNmyYuQ7cY489JoWFheaDJFH/47zmmmvM5Vy6desmie67776Tjz/+WO69914TBLt37y6//vWvpX379iYAJ5p9+/aZS/Q88MAD0rdvX+nRo4f5Y6oXev7mm28kkT355JPmOo7JYP369eb3V9/H7dq1839lZGRIotG1kjXgX3rppTJq1Cjp0qWLXHvttfKzn/1MPv30U0lEaWlpNc6r/pPz29/+VkaMGCEjR46UREc4csB/X8XFxTJkyBD/fS1btpT8/HxZuXKlJKJ//etf5rItr732mvTr108SXW5urmlB0aZ4i/6nrV96AeRE06pVK/n9738veXl55ufdu3fL3LlzzX/YPXv2lESlv68LFy40LcDJYN26dSb4JktX6ffffy/nnXdejfv1ElTjx4+XZPDMM89IaWmp3HnnnZIM6FaLMW0hUp06dapxv/43Zj2WaE477TTzlSw07J5yyik17nv77bdNi5I20ScybSFbtGiR+S/06aeflqysLElEGnInTpxort1Y+3c5kVuONPhrS4qGh65du5rWFB1Xl2i0fkq7S7U7fPXq1XLEEUeY+ibD37Ldh/7Buf3226V169aSDGg5ijFN4qr22CLtyy8vL49RqdCUPv/8c7nrrrukoKDAdKUmsssuu0wWL14sw4cPN+OQtNUwEWmXqY7RqN2ykKj0It7//ve/TReqjkHRllGdTKID7z/55BNJNAcOHDC32mqi72UdCnHiiSea7uJErG9tOiZWx5JddNFFkixoOYoxq39exx7Z++o1GCXywNVkpYNXdcCuzljTMVeJzupGmzp1qnz11VfywgsvmHELiTaDSWceJuL4sWBSUlLMbCaPx+P/u3XMMceYMWXa1WQfJpAIdBiA0lYjHXOjjjrqKNOC9NxzzyVcfQO9x3/+858n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",
            "text/plain": [
              "<Figure size 640x480 with 1 Axes>"
            ]
          },
          "metadata": {},
          "output_type": "display_data"
        }
      ],
      "source": [
        "sns.histplot(y_train)\n",
        "sns.histplot(y_valid)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 31,
      "id": "baa10c95",
      "metadata": {},
      "outputs": [],
      "source": [
        "best_params = {\n",
        "    \"boosting_type\": \"gbdt\",\n",
        "    \"colsample_bytree\": 0.6,\n",
        "    \"importance_type\": \"split\",\n",
        "    \"learning_rate\": 0.018452644928370358,\n",
        "    \"max_depth\": 8,\n",
        "    \"min_child_samples\": 11,\n",
        "    \"min_child_weight\": 4.175410890723387,\n",
        "    \"min_split_gain\": 0.01768422649000459,\n",
        "    \"n_estimators\": 20000,\n",
        "    \"n_jobs\": 0,\n",
        "    \"num_leaves\": 63,\n",
        "    \"objective\": \"regression\",\n",
        "    \"random_state\": 42,\n",
        "    \"reg_alpha\": 2.3326872626500275,\n",
        "    \"reg_lambda\": 2,\n",
        "    \"subsample\": 0.8,\n",
        "    \"max_bin\": 249,\n",
        "    \"extra_trees\": False,\n",
        "    \"verbose\": -1,\n",
        "}"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 32,
      "id": "43f1e032",
      "metadata": {},
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "Iter    0: RMSE - Train:   1.8886, Valid:   1.8716, Gap:  0.99x\n",
            "Training until validation scores don't improve for 300 rounds\n",
            "Iter  100: RMSE - Train:   1.0997, Valid:   1.1598, Gap:  1.05x Trend: Train↘ Valid↘ Gap↗\n",
            "[200]\ttraining's rmse: 0.963977\ttraining's l2: 0.929252\tvalid_1's rmse: 1.07648\tvalid_1's l2: 1.15882\n",
            "Iter  200: RMSE - Train:   0.9630, Valid:   1.0761, Gap:  1.12x Trend: Train↘ Valid↘ Gap↗\n",
            "Iter  300: RMSE - Train:   0.8976, Valid:   1.0469, Gap:  1.17x Trend: Train↘ Valid↘ Gap↗\n",
            "[400]\ttraining's rmse: 0.851446\ttraining's l2: 0.72496\tvalid_1's rmse: 1.02944\tvalid_1's l2: 1.05975\n",
            "Iter  400: RMSE - Train:   0.8511, Valid:   1.0293, Gap:  1.21x Trend: Train↘ Valid↘ Gap↗\n",
            "Iter  500: RMSE - Train:   0.8094, Valid:   1.0160, Gap:  1.26x Trend: Train↘ Valid↘ Gap↗\n",
            "[600]\ttraining's rmse: 0.774272\ttraining's l2: 0.599497\tvalid_1's rmse: 1.00573\tvalid_1's l2: 1.01148\n",
            "Iter  600: RMSE - Train:   0.7739, Valid:   1.0056, Gap:  1.30x Trend: Train↘ Valid↘ Gap↗\n",
            "Iter  700: RMSE - Train:   0.7422, Valid:   0.9965, Gap:  1.34x Trend: Train↘ Valid↘ Gap↗\n",
            "[800]\ttraining's rmse: 0.71379\ttraining's l2: 0.509497\tvalid_1's rmse: 0.989228\tvalid_1's l2: 0.978573\n",
            "Iter  800: RMSE - Train:   0.7135, Valid:   0.9892, Gap:  1.39x Trend: Train↘ Valid↘ Gap↗\n",
            "Iter  900: RMSE - Train:   0.6863, Valid:   0.9827, Gap:  1.43x Trend: Train↘ Valid↘ Gap↗\n",
            "[1000]\ttraining's rmse: 0.661215\ttraining's l2: 0.437205\tvalid_1's rmse: 0.97729\tvalid_1's l2: 0.955095\n",
            "Iter 1000: RMSE - Train:   0.6609, Valid:   0.9772, Gap:  1.48x Trend: Train↘ Valid↘ Gap↗\n",
            "Early stopping triggered at iteration 1050!\n",
            "Reason: Gap ratio 1.50x exceeds threshold 1.5x\n",
            "Final metrics - Train rmse: 0.6496, Valid rmse: 0.9747\n"
          ]
        },
        {
          "data": {
            "text/html": [
              "<style>#sk-container-id-1 {\n",
              "  /* Definition of color scheme common for light and dark mode */\n",
              "  --sklearn-color-text: #000;\n",
              "  --sklearn-color-text-muted: #666;\n",
              "  --sklearn-color-line: gray;\n",
              "  /* Definition of color scheme for unfitted estimators */\n",
              "  --sklearn-color-unfitted-level-0: #fff5e6;\n",
              "  --sklearn-color-unfitted-level-1: #f6e4d2;\n",
              "  --sklearn-color-unfitted-level-2: #ffe0b3;\n",
              "  --sklearn-color-unfitted-level-3: chocolate;\n",
              "  /* Definition of color scheme for fitted estimators */\n",
              "  --sklearn-color-fitted-level-0: #f0f8ff;\n",
              "  --sklearn-color-fitted-level-1: #d4ebff;\n",
              "  --sklearn-color-fitted-level-2: #b3dbfd;\n",
              "  --sklearn-color-fitted-level-3: cornflowerblue;\n",
              "\n",
              "  /* Specific color for light theme */\n",
              "  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));\n",
              "  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));\n",
              "  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));\n",
              "  --sklearn-color-icon: #696969;\n",
              "\n",
              "  @media (prefers-color-scheme: dark) {\n",
              "    /* Redefinition of color scheme for dark theme */\n",
              "    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));\n",
              "    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));\n",
              "    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));\n",
              "    --sklearn-color-icon: #878787;\n",
              "  }\n",
              "}\n",
              "\n",
              "#sk-container-id-1 {\n",
              "  color: var(--sklearn-color-text);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 pre {\n",
              "  padding: 0;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 input.sk-hidden--visually {\n",
              "  border: 0;\n",
              "  clip: rect(1px 1px 1px 1px);\n",
              "  clip: rect(1px, 1px, 1px, 1px);\n",
              "  height: 1px;\n",
              "  margin: -1px;\n",
              "  overflow: hidden;\n",
              "  padding: 0;\n",
              "  position: absolute;\n",
              "  width: 1px;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-dashed-wrapped {\n",
              "  border: 1px dashed var(--sklearn-color-line);\n",
              "  margin: 0 0.4em 0.5em 0.4em;\n",
              "  box-sizing: border-box;\n",
              "  padding-bottom: 0.4em;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-container {\n",
              "  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`\n",
              "     but bootstrap.min.css set `[hidden] { display: none !important; }`\n",
              "     so we also need the `!important` here to be able to override the\n",
              "     default hidden behavior on the sphinx rendered scikit-learn.org.\n",
              "     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */\n",
              "  display: inline-block !important;\n",
              "  position: relative;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-text-repr-fallback {\n",
              "  display: none;\n",
              "}\n",
              "\n",
              "div.sk-parallel-item,\n",
              "div.sk-serial,\n",
              "div.sk-item {\n",
              "  /* draw centered vertical line to link estimators */\n",
              "  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));\n",
              "  background-size: 2px 100%;\n",
              "  background-repeat: no-repeat;\n",
              "  background-position: center center;\n",
              "}\n",
              "\n",
              "/* Parallel-specific style estimator block */\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel-item::after {\n",
              "  content: \"\";\n",
              "  width: 100%;\n",
              "  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);\n",
              "  flex-grow: 1;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel {\n",
              "  display: flex;\n",
              "  align-items: stretch;\n",
              "  justify-content: center;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  position: relative;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel-item {\n",
              "  display: flex;\n",
              "  flex-direction: column;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel-item:first-child::after {\n",
              "  align-self: flex-end;\n",
              "  width: 50%;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel-item:last-child::after {\n",
              "  align-self: flex-start;\n",
              "  width: 50%;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-parallel-item:only-child::after {\n",
              "  width: 0;\n",
              "}\n",
              "\n",
              "/* Serial-specific style estimator block */\n",
              "\n",
              "#sk-container-id-1 div.sk-serial {\n",
              "  display: flex;\n",
              "  flex-direction: column;\n",
              "  align-items: center;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  padding-right: 1em;\n",
              "  padding-left: 1em;\n",
              "}\n",
              "\n",
              "\n",
              "/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is\n",
              "clickable and can be expanded/collapsed.\n",
              "- Pipeline and ColumnTransformer use this feature and define the default style\n",
              "- Estimators will overwrite some part of the style using the `sk-estimator` class\n",
              "*/\n",
              "\n",
              "/* Pipeline and ColumnTransformer style (default) */\n",
              "\n",
              "#sk-container-id-1 div.sk-toggleable {\n",
              "  /* Default theme specific background. It is overwritten whether we have a\n",
              "  specific estimator or a Pipeline/ColumnTransformer */\n",
              "  background-color: var(--sklearn-color-background);\n",
              "}\n",
              "\n",
              "/* Toggleable label */\n",
              "#sk-container-id-1 label.sk-toggleable__label {\n",
              "  cursor: pointer;\n",
              "  display: flex;\n",
              "  width: 100%;\n",
              "  margin-bottom: 0;\n",
              "  padding: 0.5em;\n",
              "  box-sizing: border-box;\n",
              "  text-align: center;\n",
              "  align-items: start;\n",
              "  justify-content: space-between;\n",
              "  gap: 0.5em;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 label.sk-toggleable__label .caption {\n",
              "  font-size: 0.6rem;\n",
              "  font-weight: lighter;\n",
              "  color: var(--sklearn-color-text-muted);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 label.sk-toggleable__label-arrow:before {\n",
              "  /* Arrow on the left of the label */\n",
              "  content: \"▸\";\n",
              "  float: left;\n",
              "  margin-right: 0.25em;\n",
              "  color: var(--sklearn-color-icon);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {\n",
              "  color: var(--sklearn-color-text);\n",
              "}\n",
              "\n",
              "/* Toggleable content - dropdown */\n",
              "\n",
              "#sk-container-id-1 div.sk-toggleable__content {\n",
              "  display: none;\n",
              "  text-align: left;\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-toggleable__content.fitted {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-toggleable__content pre {\n",
              "  margin: 0.2em;\n",
              "  border-radius: 0.25em;\n",
              "  color: var(--sklearn-color-text);\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-toggleable__content.fitted pre {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {\n",
              "  /* Expand drop-down */\n",
              "  display: block;\n",
              "  width: 100%;\n",
              "  overflow: visible;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {\n",
              "  content: \"▾\";\n",
              "}\n",
              "\n",
              "/* Pipeline/ColumnTransformer-specific style */\n",
              "\n",
              "#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Estimator-specific style */\n",
              "\n",
              "/* Colorize estimator box */\n",
              "#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-label label.sk-toggleable__label,\n",
              "#sk-container-id-1 div.sk-label label {\n",
              "  /* The background is the default theme color */\n",
              "  color: var(--sklearn-color-text-on-default-background);\n",
              "}\n",
              "\n",
              "/* On hover, darken the color of the background */\n",
              "#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "/* Label box, darken color on hover, fitted */\n",
              "#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Estimator label */\n",
              "\n",
              "#sk-container-id-1 div.sk-label label {\n",
              "  font-family: monospace;\n",
              "  font-weight: bold;\n",
              "  display: inline-block;\n",
              "  line-height: 1.2em;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-label-container {\n",
              "  text-align: center;\n",
              "}\n",
              "\n",
              "/* Estimator-specific */\n",
              "#sk-container-id-1 div.sk-estimator {\n",
              "  font-family: monospace;\n",
              "  border: 1px dotted var(--sklearn-color-border-box);\n",
              "  border-radius: 0.25em;\n",
              "  box-sizing: border-box;\n",
              "  margin-bottom: 0.5em;\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-estimator.fitted {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "/* on hover */\n",
              "#sk-container-id-1 div.sk-estimator:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-1 div.sk-estimator.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Specification for estimator info (e.g. \"i\" and \"?\") */\n",
              "\n",
              "/* Common style for \"i\" and \"?\" */\n",
              "\n",
              ".sk-estimator-doc-link,\n",
              "a:link.sk-estimator-doc-link,\n",
              "a:visited.sk-estimator-doc-link {\n",
              "  float: right;\n",
              "  font-size: smaller;\n",
              "  line-height: 1em;\n",
              "  font-family: monospace;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  border-radius: 1em;\n",
              "  height: 1em;\n",
              "  width: 1em;\n",
              "  text-decoration: none !important;\n",
              "  margin-left: 0.5em;\n",
              "  text-align: center;\n",
              "  /* unfitted */\n",
              "  border: var(--sklearn-color-unfitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-unfitted-level-1);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link.fitted,\n",
              "a:link.sk-estimator-doc-link.fitted,\n",
              "a:visited.sk-estimator-doc-link.fitted {\n",
              "  /* fitted */\n",
              "  border: var(--sklearn-color-fitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-fitted-level-1);\n",
              "}\n",
              "\n",
              "/* On hover */\n",
              "div.sk-estimator:hover .sk-estimator-doc-link:hover,\n",
              ".sk-estimator-doc-link:hover,\n",
              "div.sk-label-container:hover .sk-estimator-doc-link:hover,\n",
              ".sk-estimator-doc-link:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,\n",
              ".sk-estimator-doc-link.fitted:hover,\n",
              "div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,\n",
              ".sk-estimator-doc-link.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "/* Span, style for the box shown on hovering the info icon */\n",
              ".sk-estimator-doc-link span {\n",
              "  display: none;\n",
              "  z-index: 9999;\n",
              "  position: relative;\n",
              "  font-weight: normal;\n",
              "  right: .2ex;\n",
              "  padding: .5ex;\n",
              "  margin: .5ex;\n",
              "  width: min-content;\n",
              "  min-width: 20ex;\n",
              "  max-width: 50ex;\n",
              "  color: var(--sklearn-color-text);\n",
              "  box-shadow: 2pt 2pt 4pt #999;\n",
              "  /* unfitted */\n",
              "  background: var(--sklearn-color-unfitted-level-0);\n",
              "  border: .5pt solid var(--sklearn-color-unfitted-level-3);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link.fitted span {\n",
              "  /* fitted */\n",
              "  background: var(--sklearn-color-fitted-level-0);\n",
              "  border: var(--sklearn-color-fitted-level-3);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link:hover span {\n",
              "  display: block;\n",
              "}\n",
              "\n",
              "/* \"?\"-specific style due to the `<a>` HTML tag */\n",
              "\n",
              "#sk-container-id-1 a.estimator_doc_link {\n",
              "  float: right;\n",
              "  font-size: 1rem;\n",
              "  line-height: 1em;\n",
              "  font-family: monospace;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  border-radius: 1rem;\n",
              "  height: 1rem;\n",
              "  width: 1rem;\n",
              "  text-decoration: none;\n",
              "  /* unfitted */\n",
              "  color: var(--sklearn-color-unfitted-level-1);\n",
              "  border: var(--sklearn-color-unfitted-level-1) 1pt solid;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 a.estimator_doc_link.fitted {\n",
              "  /* fitted */\n",
              "  border: var(--sklearn-color-fitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-fitted-level-1);\n",
              "}\n",
              "\n",
              "/* On hover */\n",
              "#sk-container-id-1 a.estimator_doc_link:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "#sk-container-id-1 a.estimator_doc_link.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-3);\n",
              "}\n",
              "\n",
              ".estimator-table summary {\n",
              "    padding: .5rem;\n",
              "    font-family: monospace;\n",
              "    cursor: pointer;\n",
              "}\n",
              "\n",
              ".estimator-table details[open] {\n",
              "    padding-left: 0.1rem;\n",
              "    padding-right: 0.1rem;\n",
              "    padding-bottom: 0.3rem;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table {\n",
              "    margin-left: auto !important;\n",
              "    margin-right: auto !important;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:nth-child(odd) {\n",
              "    background-color: #fff;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:nth-child(even) {\n",
              "    background-color: #f6f6f6;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:hover {\n",
              "    background-color: #e0e0e0;\n",
              "}\n",
              "\n",
              ".estimator-table table td {\n",
              "    border: 1px solid rgba(106, 105, 104, 0.232);\n",
              "}\n",
              "\n",
              ".user-set td {\n",
              "    color:rgb(255, 94, 0);\n",
              "    text-align: left;\n",
              "}\n",
              "\n",
              ".user-set td.value pre {\n",
              "    color:rgb(255, 94, 0) !important;\n",
              "    background-color: transparent !important;\n",
              "}\n",
              "\n",
              ".default td {\n",
              "    color: black;\n",
              "    text-align: left;\n",
              "}\n",
              "\n",
              ".user-set td i,\n",
              ".default td i {\n",
              "    color: black;\n",
              "}\n",
              "\n",
              ".copy-paste-icon {\n",
              "    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);\n",
              "    background-repeat: no-repeat;\n",
              "    background-size: 14px 14px;\n",
              "    background-position: 0;\n",
              "    display: inline-block;\n",
              "    width: 14px;\n",
              "    height: 14px;\n",
              "    cursor: pointer;\n",
              "}\n",
              "</style><body><div id=\"sk-container-id-1\" class=\"sk-top-container\"><div class=\"sk-text-repr-fallback\"><pre>LGBMRegressor(colsample_bytree=0.6, extra_trees=False,\n",
              "              learning_rate=0.018452644928370357, max_bin=249, max_depth=8,\n",
              "              min_child_samples=11, min_child_weight=4.175410890723387,\n",
              "              min_split_gain=0.01768422649000459, n_estimators=20000, n_jobs=0,\n",
              "              num_leaves=63, objective=&#x27;regression&#x27;, random_state=42,\n",
              "              reg_alpha=2.3326872626500275, reg_lambda=2, subsample=0.8,\n",
              "              verbose=-1)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class=\"sk-container\" hidden><div class=\"sk-item\"><div class=\"sk-estimator fitted sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-1\" type=\"checkbox\" checked><label for=\"sk-estimator-id-1\" class=\"sk-toggleable__label fitted sk-toggleable__label-arrow\"><div><div>LGBMRegressor</div></div><div><span class=\"sk-estimator-doc-link fitted\">i<span>Fitted</span></span></div></label><div class=\"sk-toggleable__content fitted\" data-param-prefix=\"\">\n",
              "        <div class=\"estimator-table\">\n",
              "            <details>\n",
              "                <summary>Parameters</summary>\n",
              "                <table class=\"parameters-table\">\n",
              "                  <tbody>\n",
              "                    \n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('boosting_type',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">boosting_type&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;gbdt&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('num_leaves',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">num_leaves&nbsp;</td>\n",
              "            <td class=\"value\">63</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('max_depth',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">max_depth&nbsp;</td>\n",
              "            <td class=\"value\">8</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('learning_rate',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">learning_rate&nbsp;</td>\n",
              "            <td class=\"value\">0.018452644928370357</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('n_estimators',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">n_estimators&nbsp;</td>\n",
              "            <td class=\"value\">20000</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample_for_bin',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample_for_bin&nbsp;</td>\n",
              "            <td class=\"value\">200000</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('objective',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">objective&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;regression&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('class_weight',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">class_weight&nbsp;</td>\n",
              "            <td class=\"value\">None</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_split_gain',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_split_gain&nbsp;</td>\n",
              "            <td class=\"value\">0.01768422649000459</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_child_weight',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_child_weight&nbsp;</td>\n",
              "            <td class=\"value\">4.175410890723387</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_child_samples',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_child_samples&nbsp;</td>\n",
              "            <td class=\"value\">11</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample&nbsp;</td>\n",
              "            <td class=\"value\">0.8</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample_freq',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample_freq&nbsp;</td>\n",
              "            <td class=\"value\">0</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('colsample_bytree',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">colsample_bytree&nbsp;</td>\n",
              "            <td class=\"value\">0.6</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('reg_alpha',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">reg_alpha&nbsp;</td>\n",
              "            <td class=\"value\">2.3326872626500275</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('reg_lambda',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">reg_lambda&nbsp;</td>\n",
              "            <td class=\"value\">2</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('random_state',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">random_state&nbsp;</td>\n",
              "            <td class=\"value\">42</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('n_jobs',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">n_jobs&nbsp;</td>\n",
              "            <td class=\"value\">0</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('importance_type',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">importance_type&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;split&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('max_bin',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">max_bin&nbsp;</td>\n",
              "            <td class=\"value\">249</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('extra_trees',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">extra_trees&nbsp;</td>\n",
              "            <td class=\"value\">False</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('verbose',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">verbose&nbsp;</td>\n",
              "            <td class=\"value\">-1</td>\n",
              "        </tr>\n",
              "    \n",
              "                  </tbody>\n",
              "                </table>\n",
              "            </details>\n",
              "        </div>\n",
              "    </div></div></div></div></div><script>function copyToClipboard(text, element) {\n",
              "    // Get the parameter prefix from the closest toggleable content\n",
              "    const toggleableContent = element.closest('.sk-toggleable__content');\n",
              "    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';\n",
              "    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;\n",
              "\n",
              "    const originalStyle = element.style;\n",
              "    const computedStyle = window.getComputedStyle(element);\n",
              "    const originalWidth = computedStyle.width;\n",
              "    const originalHTML = element.innerHTML.replace('Copied!', '');\n",
              "\n",
              "    navigator.clipboard.writeText(fullParamName)\n",
              "        .then(() => {\n",
              "            element.style.width = originalWidth;\n",
              "            element.style.color = 'green';\n",
              "            element.innerHTML = \"Copied!\";\n",
              "\n",
              "            setTimeout(() => {\n",
              "                element.innerHTML = originalHTML;\n",
              "                element.style = originalStyle;\n",
              "            }, 2000);\n",
              "        })\n",
              "        .catch(err => {\n",
              "            console.error('Failed to copy:', err);\n",
              "            element.style.color = 'red';\n",
              "            element.innerHTML = \"Failed!\";\n",
              "            setTimeout(() => {\n",
              "                element.innerHTML = originalHTML;\n",
              "                element.style = originalStyle;\n",
              "            }, 2000);\n",
              "        });\n",
              "    return false;\n",
              "}\n",
              "\n",
              "document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {\n",
              "    const toggleableContent = element.closest('.sk-toggleable__content');\n",
              "    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';\n",
              "    const paramName = element.parentElement.nextElementSibling.textContent.trim();\n",
              "    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;\n",
              "\n",
              "    element.setAttribute('title', fullParamName);\n",
              "});\n",
              "</script></body>"
            ],
            "text/plain": [
              "LGBMRegressor(colsample_bytree=0.6, extra_trees=False,\n",
              "              learning_rate=0.018452644928370357, max_bin=249, max_depth=8,\n",
              "              min_child_samples=11, min_child_weight=4.175410890723387,\n",
              "              min_split_gain=0.01768422649000459, n_estimators=20000, n_jobs=0,\n",
              "              num_leaves=63, objective='regression', random_state=42,\n",
              "              reg_alpha=2.3326872626500275, reg_lambda=2, subsample=0.8,\n",
              "              verbose=-1)"
            ]
          },
          "execution_count": 32,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "lgbm_model = LGBMRegressor(**best_params)\n",
        "differential_stopping = SimpleGapStopping(metric_name=\"rmse\", gap_threshold=1.5)\n",
        "\n",
        "lgbm_model.fit(\n",
        "    X_train,\n",
        "    y_train,\n",
        "    eval_set=[\n",
        "        (X_train, y_train),\n",
        "        (X_valid, y_valid),\n",
        "    ],\n",
        "    eval_metric=[\"rmse\"],\n",
        "    callbacks=[\n",
        "        early_stopping(\n",
        "            stopping_rounds=300,\n",
        "        ),\n",
        "        differential_stopping,\n",
        "        log_evaluation(200),\n",
        "    ],\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 33,
      "id": "87fbe490",
      "metadata": {},
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "Train {'rmse': 207.18174049890652, 'mse': 42924.27359615624, 'mae': 113.09587531427398, 'r2': 0.7627133034630047, 'mape_%': 252.97537796296567, 'median_mape_%': 33.49961272801756, 'smape_%': 47.689602420973095}\n",
            "Valid {'rmse': 251.46216088276515, 'mse': 63233.21835582966, 'mae': 143.704143157385, 'r2': 0.651859525112868, 'mape_%': 1026.1812965366341, 'median_mape_%': 45.22361532657593, 'smape_%': 62.574346701778985}\n"
          ]
        }
      ],
      "source": [
        "print(\n",
        "    \"Train\",\n",
        "    compute_metrics(np.expm1(y_train), np.expm1(lgbm_model.predict(X_train))),\n",
        ")\n",
        "print(\n",
        "    \"Valid\",\n",
        "    compute_metrics(np.expm1(y_valid), np.expm1(lgbm_model.predict(X_valid))),\n",
        ")"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "936ec2b3",
      "metadata": {},
      "source": [
        "Train {'rmse': 203.84232135103298, 'mse': 41551.69197377779, 'mae': 111.46478050401912, 'mape*%': 128.09364609006508, 'median_mape*%': 31.86242030600316, 'smape\\_%': 45.13743681105628}\n",
        "\n",
        "Valid {'rmse': 252.2057734342869, 'mse': 63607.75215358685, 'mae': 145.4862162062353, 'mape*%': 305.73118067170253, 'median_mape*%': 44.89100410714622, 'smape\\_%': 61.949851023129874}\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 34,
      "id": "8ab374ac",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "(14707, 4903)"
            ]
          },
          "execution_count": 34,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "X_train.shape[0], X_valid.shape[0]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 35,
      "id": "2e8e568f",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "4903"
            ]
          },
          "execution_count": 35,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "len(y_valid)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 36,
      "id": "fada8819",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "count    19610.000000\n",
              "mean       347.088802\n",
              "std        425.545903\n",
              "min          0.010000\n",
              "25%         30.352500\n",
              "50%        132.500000\n",
              "75%        566.795000\n",
              "max       1770.560000\n",
              "Name: log1p_price_usd_per_m2, dtype: float64"
            ]
          },
          "execution_count": 36,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "np.expm1(Y).describe()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 37,
      "id": "5e842c1d",
      "metadata": {},
      "outputs": [],
      "source": [
        "explainer = shap.Explainer(\n",
        "    lgbm_model, feature_perturbation=\"tree_path_dependent\"\n",
        ")\n",
        "shap_values = explainer(X_valid)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "aa113708",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f4c1d4be",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": 38,
      "id": "8995493e",
      "metadata": {},
      "outputs": [],
      "source": [
        "import pickle\n",
        "\n",
        "\n",
        "# with open(\"./models/lgbm_model_log_target_1.pkl\", \"wb+\") as f:\n",
        "#     pickle.dump(lgbm_model, f)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 39,
      "id": "fc76cdb5",
      "metadata": {},
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "Train {'rmse': 207.18174049890652, 'mse': 42924.27359615624, 'mae': 113.09587531427398, 'r2': 0.7627133034630047, 'mape_%': 252.97537796296567, 'median_mape_%': 33.49961272801756, 'smape_%': 47.689602420973095}\n",
            "Valid {'rmse': 251.46216088276515, 'mse': 63233.21835582966, 'mae': 143.704143157385, 'r2': 0.651859525112868, 'mape_%': 1026.1812965366341, 'median_mape_%': 45.22361532657593, 'smape_%': 62.574346701778985}\n"
          ]
        }
      ],
      "source": [
        "print(\n",
        "    \"Train\",\n",
        "    compute_metrics(np.expm1(y_train), np.expm1(lgbm_model.predict(X_train))),\n",
        ")\n",
        "print(\n",
        "    \"Valid\",\n",
        "    compute_metrics(np.expm1(y_valid), np.expm1(lgbm_model.predict(X_valid))),\n",
        ")"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "55e34437",
      "metadata": {},
      "source": [
        "# Check Segments Metrics\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 40,
      "id": "65fd9eb7",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = pd.read_csv(\"./data/after_eda.csv\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 41,
      "id": "27a61e20",
      "metadata": {},
      "outputs": [],
      "source": [
        "df.sort_values(\"deal_date\", inplace=True)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "5f4d3c3b",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": 42,
      "id": "300f79bc",
      "metadata": {},
      "outputs": [],
      "source": [
        "TARGET = \"price_usd_per_m2\"\n",
        "TARGET_LOG = \"log1p_price_usd_per_m2\""
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 43,
      "id": "e4f476c9",
      "metadata": {},
      "outputs": [],
      "source": [
        "df = df.drop(columns=[\"inventory_id\", \"deal_date\"], errors=\"ignore\").copy()\n",
        "Y = df[TARGET_LOG]\n",
        "Y_TRUE = np.expm1(Y)\n",
        "X = df.drop(columns=[TARGET, TARGET_LOG])"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 44,
      "id": "335ef4b1",
      "metadata": {},
      "outputs": [],
      "source": [
        "cat_cols = [\n",
        "    \"property_type\",\n",
        "    \"wall_material\",\n",
        "    \"transferred_share\",\n",
        "    \"category\",\n",
        "    \"for_clusters_gr\",\n",
        "    \"Name NP\",\n",
        "    \"region_name\",\n",
        "    \"oblast_name\",\n",
        "    \"cluster\",\n",
        "]\n",
        "cat_idx = [X.columns.get_loc(c) for c in cat_cols]"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 45,
      "id": "1994f0c7",
      "metadata": {},
      "outputs": [],
      "source": [
        "X[cat_cols] = X[cat_cols].astype(\"category\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 46,
      "id": "60e03d63",
      "metadata": {},
      "outputs": [],
      "source": [
        "X_train, X_valid, y_train, y_valid = train_test_split(\n",
        "    X, Y, test_size=0.25, random_state=42, shuffle=True\n",
        ")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 47,
      "id": "4d6c3955",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "{'rmse': 219.093650312385,\n",
              " 'mse': 48002.02760720564,\n",
              " 'mae': 120.748722700035,\n",
              " 'r2': 0.7349127117537905,\n",
              " 'mape_%': 446.29657218870244,\n",
              " 'median_mape_%': 35.88778349263605,\n",
              " 'smape_%': 51.41116801040661}"
            ]
          },
          "execution_count": 47,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "compute_metrics(Y_TRUE, np.expm1(lgbm_model.predict(X)))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 48,
      "id": "8f072e18",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "{'rmse': 207.18174049890652,\n",
              " 'mse': 42924.27359615624,\n",
              " 'mae': 113.09587531427398,\n",
              " 'r2': 0.7627133034630047,\n",
              " 'mape_%': 252.97537796296567,\n",
              " 'median_mape_%': 33.49961272801756,\n",
              " 'smape_%': 47.689602420973095}"
            ]
          },
          "execution_count": 48,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "compute_metrics(np.expm1(y_train), np.expm1(lgbm_model.predict(X_train)))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 49,
      "id": "f1de3e60",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/plain": [
              "{'rmse': 251.46216088276515,\n",
              " 'mse': 63233.21835582966,\n",
              " 'mae': 143.704143157385,\n",
              " 'r2': 0.651859525112868,\n",
              " 'mape_%': 1026.1812965366341,\n",
              " 'median_mape_%': 45.22361532657593,\n",
              " 'smape_%': 62.574346701778985}"
            ]
          },
          "execution_count": 49,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "compute_metrics(np.expm1(y_valid), np.expm1(lgbm_model.predict(X_valid)))"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 50,
      "id": "678fa901",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/html": [
              "<style>#sk-container-id-2 {\n",
              "  /* Definition of color scheme common for light and dark mode */\n",
              "  --sklearn-color-text: #000;\n",
              "  --sklearn-color-text-muted: #666;\n",
              "  --sklearn-color-line: gray;\n",
              "  /* Definition of color scheme for unfitted estimators */\n",
              "  --sklearn-color-unfitted-level-0: #fff5e6;\n",
              "  --sklearn-color-unfitted-level-1: #f6e4d2;\n",
              "  --sklearn-color-unfitted-level-2: #ffe0b3;\n",
              "  --sklearn-color-unfitted-level-3: chocolate;\n",
              "  /* Definition of color scheme for fitted estimators */\n",
              "  --sklearn-color-fitted-level-0: #f0f8ff;\n",
              "  --sklearn-color-fitted-level-1: #d4ebff;\n",
              "  --sklearn-color-fitted-level-2: #b3dbfd;\n",
              "  --sklearn-color-fitted-level-3: cornflowerblue;\n",
              "\n",
              "  /* Specific color for light theme */\n",
              "  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));\n",
              "  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));\n",
              "  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));\n",
              "  --sklearn-color-icon: #696969;\n",
              "\n",
              "  @media (prefers-color-scheme: dark) {\n",
              "    /* Redefinition of color scheme for dark theme */\n",
              "    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));\n",
              "    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));\n",
              "    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));\n",
              "    --sklearn-color-icon: #878787;\n",
              "  }\n",
              "}\n",
              "\n",
              "#sk-container-id-2 {\n",
              "  color: var(--sklearn-color-text);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 pre {\n",
              "  padding: 0;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 input.sk-hidden--visually {\n",
              "  border: 0;\n",
              "  clip: rect(1px 1px 1px 1px);\n",
              "  clip: rect(1px, 1px, 1px, 1px);\n",
              "  height: 1px;\n",
              "  margin: -1px;\n",
              "  overflow: hidden;\n",
              "  padding: 0;\n",
              "  position: absolute;\n",
              "  width: 1px;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-dashed-wrapped {\n",
              "  border: 1px dashed var(--sklearn-color-line);\n",
              "  margin: 0 0.4em 0.5em 0.4em;\n",
              "  box-sizing: border-box;\n",
              "  padding-bottom: 0.4em;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-container {\n",
              "  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`\n",
              "     but bootstrap.min.css set `[hidden] { display: none !important; }`\n",
              "     so we also need the `!important` here to be able to override the\n",
              "     default hidden behavior on the sphinx rendered scikit-learn.org.\n",
              "     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */\n",
              "  display: inline-block !important;\n",
              "  position: relative;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-text-repr-fallback {\n",
              "  display: none;\n",
              "}\n",
              "\n",
              "div.sk-parallel-item,\n",
              "div.sk-serial,\n",
              "div.sk-item {\n",
              "  /* draw centered vertical line to link estimators */\n",
              "  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));\n",
              "  background-size: 2px 100%;\n",
              "  background-repeat: no-repeat;\n",
              "  background-position: center center;\n",
              "}\n",
              "\n",
              "/* Parallel-specific style estimator block */\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel-item::after {\n",
              "  content: \"\";\n",
              "  width: 100%;\n",
              "  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);\n",
              "  flex-grow: 1;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel {\n",
              "  display: flex;\n",
              "  align-items: stretch;\n",
              "  justify-content: center;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  position: relative;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel-item {\n",
              "  display: flex;\n",
              "  flex-direction: column;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel-item:first-child::after {\n",
              "  align-self: flex-end;\n",
              "  width: 50%;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel-item:last-child::after {\n",
              "  align-self: flex-start;\n",
              "  width: 50%;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-parallel-item:only-child::after {\n",
              "  width: 0;\n",
              "}\n",
              "\n",
              "/* Serial-specific style estimator block */\n",
              "\n",
              "#sk-container-id-2 div.sk-serial {\n",
              "  display: flex;\n",
              "  flex-direction: column;\n",
              "  align-items: center;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  padding-right: 1em;\n",
              "  padding-left: 1em;\n",
              "}\n",
              "\n",
              "\n",
              "/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is\n",
              "clickable and can be expanded/collapsed.\n",
              "- Pipeline and ColumnTransformer use this feature and define the default style\n",
              "- Estimators will overwrite some part of the style using the `sk-estimator` class\n",
              "*/\n",
              "\n",
              "/* Pipeline and ColumnTransformer style (default) */\n",
              "\n",
              "#sk-container-id-2 div.sk-toggleable {\n",
              "  /* Default theme specific background. It is overwritten whether we have a\n",
              "  specific estimator or a Pipeline/ColumnTransformer */\n",
              "  background-color: var(--sklearn-color-background);\n",
              "}\n",
              "\n",
              "/* Toggleable label */\n",
              "#sk-container-id-2 label.sk-toggleable__label {\n",
              "  cursor: pointer;\n",
              "  display: flex;\n",
              "  width: 100%;\n",
              "  margin-bottom: 0;\n",
              "  padding: 0.5em;\n",
              "  box-sizing: border-box;\n",
              "  text-align: center;\n",
              "  align-items: start;\n",
              "  justify-content: space-between;\n",
              "  gap: 0.5em;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 label.sk-toggleable__label .caption {\n",
              "  font-size: 0.6rem;\n",
              "  font-weight: lighter;\n",
              "  color: var(--sklearn-color-text-muted);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 label.sk-toggleable__label-arrow:before {\n",
              "  /* Arrow on the left of the label */\n",
              "  content: \"▸\";\n",
              "  float: left;\n",
              "  margin-right: 0.25em;\n",
              "  color: var(--sklearn-color-icon);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {\n",
              "  color: var(--sklearn-color-text);\n",
              "}\n",
              "\n",
              "/* Toggleable content - dropdown */\n",
              "\n",
              "#sk-container-id-2 div.sk-toggleable__content {\n",
              "  display: none;\n",
              "  text-align: left;\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-toggleable__content.fitted {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-toggleable__content pre {\n",
              "  margin: 0.2em;\n",
              "  border-radius: 0.25em;\n",
              "  color: var(--sklearn-color-text);\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-toggleable__content.fitted pre {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {\n",
              "  /* Expand drop-down */\n",
              "  display: block;\n",
              "  width: 100%;\n",
              "  overflow: visible;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {\n",
              "  content: \"▾\";\n",
              "}\n",
              "\n",
              "/* Pipeline/ColumnTransformer-specific style */\n",
              "\n",
              "#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Estimator-specific style */\n",
              "\n",
              "/* Colorize estimator box */\n",
              "#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-label label.sk-toggleable__label,\n",
              "#sk-container-id-2 div.sk-label label {\n",
              "  /* The background is the default theme color */\n",
              "  color: var(--sklearn-color-text-on-default-background);\n",
              "}\n",
              "\n",
              "/* On hover, darken the color of the background */\n",
              "#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "/* Label box, darken color on hover, fitted */\n",
              "#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {\n",
              "  color: var(--sklearn-color-text);\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Estimator label */\n",
              "\n",
              "#sk-container-id-2 div.sk-label label {\n",
              "  font-family: monospace;\n",
              "  font-weight: bold;\n",
              "  display: inline-block;\n",
              "  line-height: 1.2em;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-label-container {\n",
              "  text-align: center;\n",
              "}\n",
              "\n",
              "/* Estimator-specific */\n",
              "#sk-container-id-2 div.sk-estimator {\n",
              "  font-family: monospace;\n",
              "  border: 1px dotted var(--sklearn-color-border-box);\n",
              "  border-radius: 0.25em;\n",
              "  box-sizing: border-box;\n",
              "  margin-bottom: 0.5em;\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-0);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-estimator.fitted {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-0);\n",
              "}\n",
              "\n",
              "/* on hover */\n",
              "#sk-container-id-2 div.sk-estimator:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-2);\n",
              "}\n",
              "\n",
              "#sk-container-id-2 div.sk-estimator.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-2);\n",
              "}\n",
              "\n",
              "/* Specification for estimator info (e.g. \"i\" and \"?\") */\n",
              "\n",
              "/* Common style for \"i\" and \"?\" */\n",
              "\n",
              ".sk-estimator-doc-link,\n",
              "a:link.sk-estimator-doc-link,\n",
              "a:visited.sk-estimator-doc-link {\n",
              "  float: right;\n",
              "  font-size: smaller;\n",
              "  line-height: 1em;\n",
              "  font-family: monospace;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  border-radius: 1em;\n",
              "  height: 1em;\n",
              "  width: 1em;\n",
              "  text-decoration: none !important;\n",
              "  margin-left: 0.5em;\n",
              "  text-align: center;\n",
              "  /* unfitted */\n",
              "  border: var(--sklearn-color-unfitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-unfitted-level-1);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link.fitted,\n",
              "a:link.sk-estimator-doc-link.fitted,\n",
              "a:visited.sk-estimator-doc-link.fitted {\n",
              "  /* fitted */\n",
              "  border: var(--sklearn-color-fitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-fitted-level-1);\n",
              "}\n",
              "\n",
              "/* On hover */\n",
              "div.sk-estimator:hover .sk-estimator-doc-link:hover,\n",
              ".sk-estimator-doc-link:hover,\n",
              "div.sk-label-container:hover .sk-estimator-doc-link:hover,\n",
              ".sk-estimator-doc-link:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,\n",
              ".sk-estimator-doc-link.fitted:hover,\n",
              "div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,\n",
              ".sk-estimator-doc-link.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "/* Span, style for the box shown on hovering the info icon */\n",
              ".sk-estimator-doc-link span {\n",
              "  display: none;\n",
              "  z-index: 9999;\n",
              "  position: relative;\n",
              "  font-weight: normal;\n",
              "  right: .2ex;\n",
              "  padding: .5ex;\n",
              "  margin: .5ex;\n",
              "  width: min-content;\n",
              "  min-width: 20ex;\n",
              "  max-width: 50ex;\n",
              "  color: var(--sklearn-color-text);\n",
              "  box-shadow: 2pt 2pt 4pt #999;\n",
              "  /* unfitted */\n",
              "  background: var(--sklearn-color-unfitted-level-0);\n",
              "  border: .5pt solid var(--sklearn-color-unfitted-level-3);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link.fitted span {\n",
              "  /* fitted */\n",
              "  background: var(--sklearn-color-fitted-level-0);\n",
              "  border: var(--sklearn-color-fitted-level-3);\n",
              "}\n",
              "\n",
              ".sk-estimator-doc-link:hover span {\n",
              "  display: block;\n",
              "}\n",
              "\n",
              "/* \"?\"-specific style due to the `<a>` HTML tag */\n",
              "\n",
              "#sk-container-id-2 a.estimator_doc_link {\n",
              "  float: right;\n",
              "  font-size: 1rem;\n",
              "  line-height: 1em;\n",
              "  font-family: monospace;\n",
              "  background-color: var(--sklearn-color-background);\n",
              "  border-radius: 1rem;\n",
              "  height: 1rem;\n",
              "  width: 1rem;\n",
              "  text-decoration: none;\n",
              "  /* unfitted */\n",
              "  color: var(--sklearn-color-unfitted-level-1);\n",
              "  border: var(--sklearn-color-unfitted-level-1) 1pt solid;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 a.estimator_doc_link.fitted {\n",
              "  /* fitted */\n",
              "  border: var(--sklearn-color-fitted-level-1) 1pt solid;\n",
              "  color: var(--sklearn-color-fitted-level-1);\n",
              "}\n",
              "\n",
              "/* On hover */\n",
              "#sk-container-id-2 a.estimator_doc_link:hover {\n",
              "  /* unfitted */\n",
              "  background-color: var(--sklearn-color-unfitted-level-3);\n",
              "  color: var(--sklearn-color-background);\n",
              "  text-decoration: none;\n",
              "}\n",
              "\n",
              "#sk-container-id-2 a.estimator_doc_link.fitted:hover {\n",
              "  /* fitted */\n",
              "  background-color: var(--sklearn-color-fitted-level-3);\n",
              "}\n",
              "\n",
              ".estimator-table summary {\n",
              "    padding: .5rem;\n",
              "    font-family: monospace;\n",
              "    cursor: pointer;\n",
              "}\n",
              "\n",
              ".estimator-table details[open] {\n",
              "    padding-left: 0.1rem;\n",
              "    padding-right: 0.1rem;\n",
              "    padding-bottom: 0.3rem;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table {\n",
              "    margin-left: auto !important;\n",
              "    margin-right: auto !important;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:nth-child(odd) {\n",
              "    background-color: #fff;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:nth-child(even) {\n",
              "    background-color: #f6f6f6;\n",
              "}\n",
              "\n",
              ".estimator-table .parameters-table tr:hover {\n",
              "    background-color: #e0e0e0;\n",
              "}\n",
              "\n",
              ".estimator-table table td {\n",
              "    border: 1px solid rgba(106, 105, 104, 0.232);\n",
              "}\n",
              "\n",
              ".user-set td {\n",
              "    color:rgb(255, 94, 0);\n",
              "    text-align: left;\n",
              "}\n",
              "\n",
              ".user-set td.value pre {\n",
              "    color:rgb(255, 94, 0) !important;\n",
              "    background-color: transparent !important;\n",
              "}\n",
              "\n",
              ".default td {\n",
              "    color: black;\n",
              "    text-align: left;\n",
              "}\n",
              "\n",
              ".user-set td i,\n",
              ".default td i {\n",
              "    color: black;\n",
              "}\n",
              "\n",
              ".copy-paste-icon {\n",
              "    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);\n",
              "    background-repeat: no-repeat;\n",
              "    background-size: 14px 14px;\n",
              "    background-position: 0;\n",
              "    display: inline-block;\n",
              "    width: 14px;\n",
              "    height: 14px;\n",
              "    cursor: pointer;\n",
              "}\n",
              "</style><body><div id=\"sk-container-id-2\" class=\"sk-top-container\"><div class=\"sk-text-repr-fallback\"><pre>LGBMRegressor(colsample_bytree=0.6, extra_trees=False,\n",
              "              learning_rate=0.018452644928370357, max_bin=249, max_depth=8,\n",
              "              min_child_samples=11, min_child_weight=4.175410890723387,\n",
              "              min_split_gain=0.01768422649000459, n_estimators=20000, n_jobs=0,\n",
              "              num_leaves=63, objective=&#x27;regression&#x27;, random_state=42,\n",
              "              reg_alpha=2.3326872626500275, reg_lambda=2, subsample=0.8,\n",
              "              verbose=-1)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class=\"sk-container\" hidden><div class=\"sk-item\"><div class=\"sk-estimator fitted sk-toggleable\"><input class=\"sk-toggleable__control sk-hidden--visually\" id=\"sk-estimator-id-2\" type=\"checkbox\" checked><label for=\"sk-estimator-id-2\" class=\"sk-toggleable__label fitted sk-toggleable__label-arrow\"><div><div>LGBMRegressor</div></div><div><span class=\"sk-estimator-doc-link fitted\">i<span>Fitted</span></span></div></label><div class=\"sk-toggleable__content fitted\" data-param-prefix=\"\">\n",
              "        <div class=\"estimator-table\">\n",
              "            <details>\n",
              "                <summary>Parameters</summary>\n",
              "                <table class=\"parameters-table\">\n",
              "                  <tbody>\n",
              "                    \n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('boosting_type',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">boosting_type&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;gbdt&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('num_leaves',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">num_leaves&nbsp;</td>\n",
              "            <td class=\"value\">63</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('max_depth',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">max_depth&nbsp;</td>\n",
              "            <td class=\"value\">8</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('learning_rate',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">learning_rate&nbsp;</td>\n",
              "            <td class=\"value\">0.018452644928370357</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('n_estimators',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">n_estimators&nbsp;</td>\n",
              "            <td class=\"value\">20000</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample_for_bin',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample_for_bin&nbsp;</td>\n",
              "            <td class=\"value\">200000</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('objective',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">objective&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;regression&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('class_weight',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">class_weight&nbsp;</td>\n",
              "            <td class=\"value\">None</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_split_gain',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_split_gain&nbsp;</td>\n",
              "            <td class=\"value\">0.01768422649000459</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_child_weight',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_child_weight&nbsp;</td>\n",
              "            <td class=\"value\">4.175410890723387</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('min_child_samples',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">min_child_samples&nbsp;</td>\n",
              "            <td class=\"value\">11</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample&nbsp;</td>\n",
              "            <td class=\"value\">0.8</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('subsample_freq',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">subsample_freq&nbsp;</td>\n",
              "            <td class=\"value\">0</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('colsample_bytree',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">colsample_bytree&nbsp;</td>\n",
              "            <td class=\"value\">0.6</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('reg_alpha',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">reg_alpha&nbsp;</td>\n",
              "            <td class=\"value\">2.3326872626500275</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('reg_lambda',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">reg_lambda&nbsp;</td>\n",
              "            <td class=\"value\">2</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('random_state',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">random_state&nbsp;</td>\n",
              "            <td class=\"value\">42</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('n_jobs',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">n_jobs&nbsp;</td>\n",
              "            <td class=\"value\">0</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"default\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('importance_type',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">importance_type&nbsp;</td>\n",
              "            <td class=\"value\">&#x27;split&#x27;</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('max_bin',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">max_bin&nbsp;</td>\n",
              "            <td class=\"value\">249</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('extra_trees',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">extra_trees&nbsp;</td>\n",
              "            <td class=\"value\">False</td>\n",
              "        </tr>\n",
              "    \n",
              "\n",
              "        <tr class=\"user-set\">\n",
              "            <td><i class=\"copy-paste-icon\"\n",
              "                 onclick=\"copyToClipboard('verbose',\n",
              "                          this.parentElement.nextElementSibling)\"\n",
              "            ></i></td>\n",
              "            <td class=\"param\">verbose&nbsp;</td>\n",
              "            <td class=\"value\">-1</td>\n",
              "        </tr>\n",
              "    \n",
              "                  </tbody>\n",
              "                </table>\n",
              "            </details>\n",
              "        </div>\n",
              "    </div></div></div></div></div><script>function copyToClipboard(text, element) {\n",
              "    // Get the parameter prefix from the closest toggleable content\n",
              "    const toggleableContent = element.closest('.sk-toggleable__content');\n",
              "    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';\n",
              "    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;\n",
              "\n",
              "    const originalStyle = element.style;\n",
              "    const computedStyle = window.getComputedStyle(element);\n",
              "    const originalWidth = computedStyle.width;\n",
              "    const originalHTML = element.innerHTML.replace('Copied!', '');\n",
              "\n",
              "    navigator.clipboard.writeText(fullParamName)\n",
              "        .then(() => {\n",
              "            element.style.width = originalWidth;\n",
              "            element.style.color = 'green';\n",
              "            element.innerHTML = \"Copied!\";\n",
              "\n",
              "            setTimeout(() => {\n",
              "                element.innerHTML = originalHTML;\n",
              "                element.style = originalStyle;\n",
              "            }, 2000);\n",
              "        })\n",
              "        .catch(err => {\n",
              "            console.error('Failed to copy:', err);\n",
              "            element.style.color = 'red';\n",
              "            element.innerHTML = \"Failed!\";\n",
              "            setTimeout(() => {\n",
              "                element.innerHTML = originalHTML;\n",
              "                element.style = originalStyle;\n",
              "            }, 2000);\n",
              "        });\n",
              "    return false;\n",
              "}\n",
              "\n",
              "document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {\n",
              "    const toggleableContent = element.closest('.sk-toggleable__content');\n",
              "    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';\n",
              "    const paramName = element.parentElement.nextElementSibling.textContent.trim();\n",
              "    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;\n",
              "\n",
              "    element.setAttribute('title', fullParamName);\n",
              "});\n",
              "</script></body>"
            ],
            "text/plain": [
              "LGBMRegressor(colsample_bytree=0.6, extra_trees=False,\n",
              "              learning_rate=0.018452644928370357, max_bin=249, max_depth=8,\n",
              "              min_child_samples=11, min_child_weight=4.175410890723387,\n",
              "              min_split_gain=0.01768422649000459, n_estimators=20000, n_jobs=0,\n",
              "              num_leaves=63, objective='regression', random_state=42,\n",
              "              reg_alpha=2.3326872626500275, reg_lambda=2, subsample=0.8,\n",
              "              verbose=-1)"
            ]
          },
          "execution_count": 50,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "lgbm_model"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "a80667d0",
      "metadata": {},
      "outputs": [],
      "source": [
        "explainer = shap.Explainer(\n",
        "    lgbm_model, feature_perturbation=\"tree_path_dependent\"\n",
        ")\n",
        "shap_values = explainer(X)\n",
        "shap.summary_plot(shap_values, X, max_display=20)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "cc612eb7",
      "metadata": {},
      "outputs": [],
      "source": [
        "X.nunique()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 51,
      "id": "1ae18379",
      "metadata": {},
      "outputs": [
        {
          "name": "stderr",
          "output_type": "stream",
          "text": [
            "property_type: 100%|██████████| 2/2 [00:00<00:00,  9.25it/s]\n",
            "Name NP: 100%|██████████| 194/194 [00:01<00:00, 124.76it/s]\n",
            "region_name: 100%|██████████| 119/119 [00:01<00:00, 113.54it/s]\n",
            "wall_material: 100%|██████████| 14/14 [00:00<00:00, 43.16it/s]\n",
            "cluster: 100%|██████████| 7/7 [00:00<00:00, 22.39it/s]\n",
            "category: 100%|██████████| 7/7 [00:00<00:00, 26.13it/s]\n",
            "floors_below: 100%|██████████| 5/5 [00:00<00:00, 21.81it/s]\n",
            "for_clusters_gr: 100%|██████████| 3/3 [00:00<00:00, 13.63it/s]\n",
            "oblast_name: 100%|██████████| 7/7 [00:00<00:00, 24.64it/s]\n"
          ]
        }
      ],
      "source": [
        "results = []\n",
        "\n",
        "\n",
        "# Один раз вычисляем exp\n",
        "y_true_full = np.expm1(Y)\n",
        "segment_cols = [\n",
        "    \"property_type\",\n",
        "    \"Name NP\",\n",
        "    \"region_name\",\n",
        "    \"wall_material\",\n",
        "    \"cluster\",\n",
        "    \"category\",\n",
        "    \"floors_below\",\n",
        "    \"for_clusters_gr\",\n",
        "    \"oblast_name\",\n",
        "]\n",
        "\n",
        "for col in segment_cols:\n",
        "    for val in tqdm(X[col].unique(), desc=col):\n",
        "        if pd.isna(val):\n",
        "            mask = X[col].isna()  # выбираем все NaN\n",
        "            segment_val = \"NaN\"\n",
        "        else:\n",
        "            mask = X[col] == val\n",
        "            segment_val = val\n",
        "\n",
        "        y_true = y_true_full[mask]\n",
        "        X_seg = X.loc[mask]\n",
        "\n",
        "        y_pred = np.expm1(lgbm_model.predict(X_seg))\n",
        "        metrics = compute_metrics(y_true, y_pred)\n",
        "\n",
        "        results.append(\n",
        "            {\n",
        "                \"segment_col\": col,\n",
        "                \"segment_val\": segment_val,\n",
        "                \"n_samples\": len(X_seg),\n",
        "                **metrics,\n",
        "            }\n",
        "        )\n",
        "\n",
        "results_df = pd.DataFrame(results)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 52,
      "id": "f82b724c",
      "metadata": {},
      "outputs": [
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "(358, 10)\n",
            "(84, 10)\n"
          ]
        }
      ],
      "source": [
        "print(results_df.shape)\n",
        "results_df = results_df[results_df[\"n_samples\"] > 100]\n",
        "print(results_df.shape)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": 53,
      "id": "577416ff",
      "metadata": {},
      "outputs": [
        {
          "data": {
            "text/html": [
              "<div>\n",
              "<style scoped>\n",
              "    .dataframe tbody tr th:only-of-type {\n",
              "        vertical-align: middle;\n",
              "    }\n",
              "\n",
              "    .dataframe tbody tr th {\n",
              "        vertical-align: top;\n",
              "    }\n",
              "\n",
              "    .dataframe thead th {\n",
              "        text-align: right;\n",
              "    }\n",
              "</style>\n",
              "<table border=\"1\" class=\"dataframe\">\n",
              "  <thead>\n",
              "    <tr style=\"text-align: right;\">\n",
              "      <th></th>\n",
              "      <th>segment_col</th>\n",
              "      <th>segment_val</th>\n",
              "      <th>n_samples</th>\n",
              "      <th>rmse</th>\n",
              "      <th>mse</th>\n",
              "      <th>mae</th>\n",
              "      <th>r2</th>\n",
              "      <th>mape_%</th>\n",
              "      <th>median_mape_%</th>\n",
              "      <th>smape_%</th>\n",
              "    </tr>\n",
              "  </thead>\n",
              "  <tbody>\n",
              "    <tr>\n",
              "      <th>0</th>\n",
              "      <td>property_type</td>\n",
              "      <td>Капитальное строение</td>\n",
              "      <td>9408</td>\n",
              "      <td>165.494025</td>\n",
              "      <td>27388.272437</td>\n",
              "      <td>69.523836</td>\n",
              "      <td>0.556049</td>\n",
              "      <td>610.877846</td>\n",
              "      <td>45.579856</td>\n",
              "      <td>62.067040</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>1</th>\n",
              "      <td>property_type</td>\n",
              "      <td>Изолированное помещение</td>\n",
              "      <td>10202</td>\n",
              "      <td>258.865714</td>\n",
              "      <td>67011.457978</td>\n",
              "      <td>167.986886</td>\n",
              "      <td>0.691775</td>\n",
              "      <td>294.524310</td>\n",
              "      <td>30.164077</td>\n",
              "      <td>41.584620</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>2</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>-1</td>\n",
              "      <td>7533</td>\n",
              "      <td>146.665056</td>\n",
              "      <td>21510.638536</td>\n",
              "      <td>63.476997</td>\n",
              "      <td>0.703775</td>\n",
              "      <td>442.244857</td>\n",
              "      <td>40.723937</td>\n",
              "      <td>57.606556</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>3</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>гомель</td>\n",
              "      <td>551</td>\n",
              "      <td>293.061224</td>\n",
              "      <td>85884.881173</td>\n",
              "      <td>190.871640</td>\n",
              "      <td>0.490603</td>\n",
              "      <td>248.099547</td>\n",
              "      <td>39.469551</td>\n",
              "      <td>54.222497</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>4</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>молодечно</td>\n",
              "      <td>168</td>\n",
              "      <td>159.759882</td>\n",
              "      <td>25523.219827</td>\n",
              "      <td>84.450518</td>\n",
              "      <td>0.619302</td>\n",
              "      <td>524.854944</td>\n",
              "      <td>35.477995</td>\n",
              "      <td>47.812399</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>6</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>полоцк</td>\n",
              "      <td>228</td>\n",
              "      <td>178.754330</td>\n",
              "      <td>31953.110391</td>\n",
              "      <td>81.455634</td>\n",
              "      <td>0.522415</td>\n",
              "      <td>1068.362000</td>\n",
              "      <td>50.261404</td>\n",
              "      <td>65.179088</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>8</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>могилев</td>\n",
              "      <td>480</td>\n",
              "      <td>252.226924</td>\n",
              "      <td>63618.421431</td>\n",
              "      <td>149.258215</td>\n",
              "      <td>0.483775</td>\n",
              "      <td>373.524970</td>\n",
              "      <td>47.429464</td>\n",
              "      <td>61.473018</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>9</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>бобруйск</td>\n",
              "      <td>329</td>\n",
              "      <td>194.329429</td>\n",
              "      <td>37763.926811</td>\n",
              "      <td>98.637470</td>\n",
              "      <td>0.368943</td>\n",
              "      <td>312.795390</td>\n",
              "      <td>45.804759</td>\n",
              "      <td>62.122715</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>10</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>гродно</td>\n",
              "      <td>593</td>\n",
              "      <td>266.228220</td>\n",
              "      <td>70877.465372</td>\n",
              "      <td>180.770387</td>\n",
              "      <td>0.510362</td>\n",
              "      <td>186.851102</td>\n",
              "      <td>29.683203</td>\n",
              "      <td>41.280115</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>13</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>барановичи</td>\n",
              "      <td>233</td>\n",
              "      <td>232.012306</td>\n",
              "      <td>53829.710145</td>\n",
              "      <td>129.151096</td>\n",
              "      <td>0.513537</td>\n",
              "      <td>102.660598</td>\n",
              "      <td>41.449365</td>\n",
              "      <td>53.358417</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>16</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>минск</td>\n",
              "      <td>3961</td>\n",
              "      <td>331.856085</td>\n",
              "      <td>110128.461472</td>\n",
              "      <td>252.168151</td>\n",
              "      <td>0.380093</td>\n",
              "      <td>521.733514</td>\n",
              "      <td>25.379418</td>\n",
              "      <td>34.585655</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>28</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>брест</td>\n",
              "      <td>611</td>\n",
              "      <td>280.827376</td>\n",
              "      <td>78864.015272</td>\n",
              "      <td>185.089161</td>\n",
              "      <td>0.519775</td>\n",
              "      <td>74.186605</td>\n",
              "      <td>33.333520</td>\n",
              "      <td>45.664942</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>30</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>городок</td>\n",
              "      <td>110</td>\n",
              "      <td>118.485194</td>\n",
              "      <td>14038.741171</td>\n",
              "      <td>49.059894</td>\n",
              "      <td>0.834349</td>\n",
              "      <td>263.860491</td>\n",
              "      <td>31.560056</td>\n",
              "      <td>45.549539</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>31</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>борисов</td>\n",
              "      <td>194</td>\n",
              "      <td>262.765068</td>\n",
              "      <td>69045.480701</td>\n",
              "      <td>147.997721</td>\n",
              "      <td>0.350658</td>\n",
              "      <td>1198.437137</td>\n",
              "      <td>51.379054</td>\n",
              "      <td>65.931446</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>46</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>орша</td>\n",
              "      <td>183</td>\n",
              "      <td>172.702757</td>\n",
              "      <td>29826.242304</td>\n",
              "      <td>97.340985</td>\n",
              "      <td>0.608672</td>\n",
              "      <td>583.539435</td>\n",
              "      <td>37.538518</td>\n",
              "      <td>54.225720</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>49</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>пинск</td>\n",
              "      <td>193</td>\n",
              "      <td>229.114011</td>\n",
              "      <td>52493.229947</td>\n",
              "      <td>133.063733</td>\n",
              "      <td>0.397392</td>\n",
              "      <td>87.390162</td>\n",
              "      <td>46.148773</td>\n",
              "      <td>56.325724</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>50</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>лида</td>\n",
              "      <td>150</td>\n",
              "      <td>188.447640</td>\n",
              "      <td>35512.512987</td>\n",
              "      <td>102.271253</td>\n",
              "      <td>0.568186</td>\n",
              "      <td>60.917477</td>\n",
              "      <td>36.905726</td>\n",
              "      <td>46.944860</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>54</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>витебск</td>\n",
              "      <td>547</td>\n",
              "      <td>185.454098</td>\n",
              "      <td>34393.222552</td>\n",
              "      <td>107.229911</td>\n",
              "      <td>0.605319</td>\n",
              "      <td>81.913314</td>\n",
              "      <td>34.766680</td>\n",
              "      <td>48.788089</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>66</th>\n",
              "      <td>Name NP</td>\n",
              "      <td>слуцк</td>\n",
              "      <td>101</td>\n",
              "      <td>84.568728</td>\n",
              "      <td>7151.869814</td>\n",
              "      <td>46.545054</td>\n",
              "      <td>0.655946</td>\n",
              "      <td>262.450916</td>\n",
              "      <td>48.343529</td>\n",
              "      <td>53.500591</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>197</th>\n",
              "      <td>region_name</td>\n",
              "      <td>речицкий</td>\n",
              "      <td>191</td>\n",
              "      <td>199.007305</td>\n",
              "      <td>39603.907348</td>\n",
              "      <td>114.580966</td>\n",
              "      <td>0.711737</td>\n",
              "      <td>231.385938</td>\n",
              "      <td>40.994708</td>\n",
              "      <td>56.639840</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>200</th>\n",
              "      <td>region_name</td>\n",
              "      <td>полоцкий</td>\n",
              "      <td>376</td>\n",
              "      <td>185.411206</td>\n",
              "      <td>34377.315489</td>\n",
              "      <td>79.021058</td>\n",
              "      <td>0.662685</td>\n",
              "      <td>1001.319259</td>\n",
              "      <td>42.058315</td>\n",
              "      <td>62.322872</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>202</th>\n",
              "      <td>region_name</td>\n",
              "      <td>барановичский</td>\n",
              "      <td>112</td>\n",
              "      <td>153.121573</td>\n",
              "      <td>23446.216161</td>\n",
              "      <td>52.605000</td>\n",
              "      <td>0.881864</td>\n",
              "      <td>628.993569</td>\n",
              "      <td>48.998463</td>\n",
              "      <td>75.000758</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>204</th>\n",
              "      <td>region_name</td>\n",
              "      <td>-1</td>\n",
              "      <td>9498</td>\n",
              "      <td>265.093856</td>\n",
              "      <td>70274.752753</td>\n",
              "      <td>170.536688</td>\n",
              "      <td>0.684791</td>\n",
              "      <td>349.167013</td>\n",
              "      <td>32.923106</td>\n",
              "      <td>45.681989</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>205</th>\n",
              "      <td>region_name</td>\n",
              "      <td>лидский</td>\n",
              "      <td>220</td>\n",
              "      <td>166.153972</td>\n",
              "      <td>27607.142530</td>\n",
              "      <td>85.271831</td>\n",
              "      <td>0.598522</td>\n",
              "      <td>176.832568</td>\n",
              "      <td>40.709415</td>\n",
              "      <td>56.564431</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>206</th>\n",
              "      <td>region_name</td>\n",
              "      <td>молодечненский</td>\n",
              "      <td>236</td>\n",
              "      <td>149.708109</td>\n",
              "      <td>22412.517756</td>\n",
              "      <td>74.251513</td>\n",
              "      <td>0.626451</td>\n",
              "      <td>604.850087</td>\n",
              "      <td>45.360496</td>\n",
              "      <td>61.396704</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>208</th>\n",
              "      <td>region_name</td>\n",
              "      <td>брестский</td>\n",
              "      <td>195</td>\n",
              "      <td>113.134599</td>\n",
              "      <td>12799.437600</td>\n",
              "      <td>45.497206</td>\n",
              "      <td>0.114480</td>\n",
              "      <td>263.541644</td>\n",
              "      <td>27.318645</td>\n",
              "      <td>43.721308</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>211</th>\n",
              "      <td>region_name</td>\n",
              "      <td>солигорский</td>\n",
              "      <td>152</td>\n",
              "      <td>193.106570</td>\n",
              "      <td>37290.147490</td>\n",
              "      <td>104.242903</td>\n",
              "      <td>0.671933</td>\n",
              "      <td>297.298572</td>\n",
              "      <td>44.026712</td>\n",
              "      <td>64.084233</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>212</th>\n",
              "      <td>region_name</td>\n",
              "      <td>гродненский</td>\n",
              "      <td>140</td>\n",
              "      <td>109.990896</td>\n",
              "      <td>12097.997282</td>\n",
              "      <td>59.964908</td>\n",
              "      <td>0.508066</td>\n",
              "      <td>860.729494</td>\n",
              "      <td>45.766736</td>\n",
              "      <td>65.628976</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>213</th>\n",
              "      <td>region_name</td>\n",
              "      <td>осиповичский</td>\n",
              "      <td>139</td>\n",
              "      <td>85.680485</td>\n",
              "      <td>7341.145430</td>\n",
              "      <td>41.959931</td>\n",
              "      <td>0.780013</td>\n",
              "      <td>841.040171</td>\n",
              "      <td>46.890270</td>\n",
              "      <td>66.145682</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>216</th>\n",
              "      <td>region_name</td>\n",
              "      <td>минский</td>\n",
              "      <td>1151</td>\n",
              "      <td>231.650483</td>\n",
              "      <td>53661.946302</td>\n",
              "      <td>142.159098</td>\n",
              "      <td>0.650614</td>\n",
              "      <td>61.751264</td>\n",
              "      <td>26.070965</td>\n",
              "      <td>36.218943</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>220</th>\n",
              "      <td>region_name</td>\n",
              "      <td>логойский</td>\n",
              "      <td>155</td>\n",
              "      <td>252.037873</td>\n",
              "      <td>63523.089630</td>\n",
              "      <td>128.760515</td>\n",
              "      <td>0.775382</td>\n",
              "      <td>190.077836</td>\n",
              "      <td>27.226533</td>\n",
              "      <td>43.481838</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>227</th>\n",
              "      <td>region_name</td>\n",
              "      <td>дрогичинский</td>\n",
              "      <td>101</td>\n",
              "      <td>171.221626</td>\n",
              "      <td>29316.845188</td>\n",
              "      <td>55.271469</td>\n",
              "      <td>0.596891</td>\n",
              "      <td>197.495941</td>\n",
              "      <td>27.760850</td>\n",
              "      <td>47.184543</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>230</th>\n",
              "      <td>region_name</td>\n",
              "      <td>сморгонский</td>\n",
              "      <td>102</td>\n",
              "      <td>250.578275</td>\n",
              "      <td>62789.471905</td>\n",
              "      <td>108.319799</td>\n",
              "      <td>0.615669</td>\n",
              "      <td>119.906192</td>\n",
              "      <td>39.369320</td>\n",
              "      <td>57.540916</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>233</th>\n",
              "      <td>region_name</td>\n",
              "      <td>жлобинский</td>\n",
              "      <td>231</td>\n",
              "      <td>92.111177</td>\n",
              "      <td>8484.468978</td>\n",
              "      <td>29.659786</td>\n",
              "      <td>0.617182</td>\n",
              "      <td>159.556057</td>\n",
              "      <td>13.402117</td>\n",
              "      <td>34.236539</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>236</th>\n",
              "      <td>region_name</td>\n",
              "      <td>браславский</td>\n",
              "      <td>105</td>\n",
              "      <td>108.365398</td>\n",
              "      <td>11743.059435</td>\n",
              "      <td>41.792874</td>\n",
              "      <td>0.528324</td>\n",
              "      <td>332.698102</td>\n",
              "      <td>45.092145</td>\n",
              "      <td>63.090324</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>237</th>\n",
              "      <td>region_name</td>\n",
              "      <td>вилейский</td>\n",
              "      <td>101</td>\n",
              "      <td>254.071845</td>\n",
              "      <td>64552.502243</td>\n",
              "      <td>85.591714</td>\n",
              "      <td>0.507642</td>\n",
              "      <td>669.917289</td>\n",
              "      <td>31.105875</td>\n",
              "      <td>46.101060</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>240</th>\n",
              "      <td>region_name</td>\n",
              "      <td>смолевичский</td>\n",
              "      <td>159</td>\n",
              "      <td>91.817310</td>\n",
              "      <td>8430.418467</td>\n",
              "      <td>45.584840</td>\n",
              "      <td>0.802742</td>\n",
              "      <td>41.911664</td>\n",
              "      <td>31.551699</td>\n",
              "      <td>38.695148</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>252</th>\n",
              "      <td>region_name</td>\n",
              "      <td>березовский</td>\n",
              "      <td>112</td>\n",
              "      <td>135.600542</td>\n",
              "      <td>18387.507040</td>\n",
              "      <td>50.679183</td>\n",
              "      <td>0.853314</td>\n",
              "      <td>372.784284</td>\n",
              "      <td>31.877495</td>\n",
              "      <td>57.047170</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>255</th>\n",
              "      <td>region_name</td>\n",
              "      <td>пружанский</td>\n",
              "      <td>105</td>\n",
              "      <td>103.791373</td>\n",
              "      <td>10772.649158</td>\n",
              "      <td>51.206437</td>\n",
              "      <td>0.605455</td>\n",
              "      <td>588.413919</td>\n",
              "      <td>58.124728</td>\n",
              "      <td>70.137870</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>256</th>\n",
              "      <td>region_name</td>\n",
              "      <td>оршанский</td>\n",
              "      <td>283</td>\n",
              "      <td>152.776635</td>\n",
              "      <td>23340.700348</td>\n",
              "      <td>75.497612</td>\n",
              "      <td>0.694061</td>\n",
              "      <td>746.207026</td>\n",
              "      <td>38.698937</td>\n",
              "      <td>59.116240</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>257</th>\n",
              "      <td>region_name</td>\n",
              "      <td>дзержинский</td>\n",
              "      <td>175</td>\n",
              "      <td>171.939121</td>\n",
              "      <td>29563.061165</td>\n",
              "      <td>99.363740</td>\n",
              "      <td>0.708312</td>\n",
              "      <td>49.483056</td>\n",
              "      <td>27.984370</td>\n",
              "      <td>39.176903</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>264</th>\n",
              "      <td>region_name</td>\n",
              "      <td>борисовский</td>\n",
              "      <td>293</td>\n",
              "      <td>229.796949</td>\n",
              "      <td>52806.637880</td>\n",
              "      <td>117.897652</td>\n",
              "      <td>0.387133</td>\n",
              "      <td>1340.209085</td>\n",
              "      <td>50.192360</td>\n",
              "      <td>66.378158</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>269</th>\n",
              "      <td>region_name</td>\n",
              "      <td>слуцкий</td>\n",
              "      <td>133</td>\n",
              "      <td>91.127034</td>\n",
              "      <td>8304.136373</td>\n",
              "      <td>46.967950</td>\n",
              "      <td>0.618046</td>\n",
              "      <td>738.115136</td>\n",
              "      <td>53.947539</td>\n",
              "      <td>60.122827</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>271</th>\n",
              "      <td>region_name</td>\n",
              "      <td>слонимский</td>\n",
              "      <td>138</td>\n",
              "      <td>113.030068</td>\n",
              "      <td>12775.796282</td>\n",
              "      <td>44.026886</td>\n",
              "      <td>0.567039</td>\n",
              "      <td>344.702666</td>\n",
              "      <td>37.699614</td>\n",
              "      <td>55.932690</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>282</th>\n",
              "      <td>region_name</td>\n",
              "      <td>г. витебск</td>\n",
              "      <td>547</td>\n",
              "      <td>185.454098</td>\n",
              "      <td>34393.222552</td>\n",
              "      <td>107.229911</td>\n",
              "      <td>0.605319</td>\n",
              "      <td>81.913314</td>\n",
              "      <td>34.766680</td>\n",
              "      <td>48.788089</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>285</th>\n",
              "      <td>region_name</td>\n",
              "      <td>мозырский</td>\n",
              "      <td>138</td>\n",
              "      <td>206.516083</td>\n",
              "      <td>42648.892511</td>\n",
              "      <td>81.343557</td>\n",
              "      <td>0.481844</td>\n",
              "      <td>460.857813</td>\n",
              "      <td>35.036829</td>\n",
              "      <td>49.455871</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>303</th>\n",
              "      <td>region_name</td>\n",
              "      <td>мядельский</td>\n",
              "      <td>108</td>\n",
              "      <td>95.726646</td>\n",
              "      <td>9163.590760</td>\n",
              "      <td>40.361112</td>\n",
              "      <td>0.449631</td>\n",
              "      <td>375.788865</td>\n",
              "      <td>60.420068</td>\n",
              "      <td>66.904799</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>315</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Кирпич</td>\n",
              "      <td>10242</td>\n",
              "      <td>192.160047</td>\n",
              "      <td>36925.483821</td>\n",
              "      <td>95.549100</td>\n",
              "      <td>0.654249</td>\n",
              "      <td>499.321192</td>\n",
              "      <td>41.609103</td>\n",
              "      <td>56.988836</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>316</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Смешанные/каркасные</td>\n",
              "      <td>1065</td>\n",
              "      <td>227.302320</td>\n",
              "      <td>51666.344500</td>\n",
              "      <td>126.897245</td>\n",
              "      <td>0.777948</td>\n",
              "      <td>229.603105</td>\n",
              "      <td>35.109137</td>\n",
              "      <td>49.398956</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>317</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Деревянные</td>\n",
              "      <td>944</td>\n",
              "      <td>158.013101</td>\n",
              "      <td>24968.140091</td>\n",
              "      <td>62.231555</td>\n",
              "      <td>0.720098</td>\n",
              "      <td>521.922937</td>\n",
              "      <td>48.072713</td>\n",
              "      <td>67.274802</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>318</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Панели</td>\n",
              "      <td>685</td>\n",
              "      <td>235.986364</td>\n",
              "      <td>55689.563850</td>\n",
              "      <td>139.038115</td>\n",
              "      <td>0.692010</td>\n",
              "      <td>274.682560</td>\n",
              "      <td>30.825598</td>\n",
              "      <td>45.619854</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>320</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Блоки (легкие)</td>\n",
              "      <td>920</td>\n",
              "      <td>293.027154</td>\n",
              "      <td>85864.913033</td>\n",
              "      <td>198.416679</td>\n",
              "      <td>0.644236</td>\n",
              "      <td>147.712474</td>\n",
              "      <td>33.985227</td>\n",
              "      <td>47.324875</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>321</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Бетон</td>\n",
              "      <td>136</td>\n",
              "      <td>207.636715</td>\n",
              "      <td>43113.005417</td>\n",
              "      <td>112.101174</td>\n",
              "      <td>0.804298</td>\n",
              "      <td>120.961629</td>\n",
              "      <td>27.506068</td>\n",
              "      <td>43.686433</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>322</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Металл</td>\n",
              "      <td>506</td>\n",
              "      <td>196.191110</td>\n",
              "      <td>38490.951761</td>\n",
              "      <td>107.530228</td>\n",
              "      <td>0.665268</td>\n",
              "      <td>113.589175</td>\n",
              "      <td>36.392148</td>\n",
              "      <td>47.172334</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>323</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Блоки</td>\n",
              "      <td>1931</td>\n",
              "      <td>283.643635</td>\n",
              "      <td>80453.711697</td>\n",
              "      <td>194.215404</td>\n",
              "      <td>0.644474</td>\n",
              "      <td>138.084945</td>\n",
              "      <td>26.220882</td>\n",
              "      <td>38.586075</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>324</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Другое/Иное</td>\n",
              "      <td>1849</td>\n",
              "      <td>230.064557</td>\n",
              "      <td>52929.700348</td>\n",
              "      <td>139.085637</td>\n",
              "      <td>0.762579</td>\n",
              "      <td>1102.866918</td>\n",
              "      <td>27.137543</td>\n",
              "      <td>41.231628</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>326</th>\n",
              "      <td>wall_material</td>\n",
              "      <td>Железобетон</td>\n",
              "      <td>1259</td>\n",
              "      <td>253.658763</td>\n",
              "      <td>64342.768061</td>\n",
              "      <td>158.613956</td>\n",
              "      <td>0.731210</td>\n",
              "      <td>114.881113</td>\n",
              "      <td>26.379246</td>\n",
              "      <td>38.669070</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>329</th>\n",
              "      <td>cluster</td>\n",
              "      <td>F</td>\n",
              "      <td>1533</td>\n",
              "      <td>118.540531</td>\n",
              "      <td>14051.857402</td>\n",
              "      <td>43.628150</td>\n",
              "      <td>0.735864</td>\n",
              "      <td>610.759922</td>\n",
              "      <td>42.570264</td>\n",
              "      <td>63.009194</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>330</th>\n",
              "      <td>cluster</td>\n",
              "      <td>E</td>\n",
              "      <td>2952</td>\n",
              "      <td>135.682690</td>\n",
              "      <td>18409.792400</td>\n",
              "      <td>52.820790</td>\n",
              "      <td>0.670425</td>\n",
              "      <td>905.151134</td>\n",
              "      <td>47.596120</td>\n",
              "      <td>67.015108</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>331</th>\n",
              "      <td>cluster</td>\n",
              "      <td>D</td>\n",
              "      <td>2200</td>\n",
              "      <td>167.619816</td>\n",
              "      <td>28096.402824</td>\n",
              "      <td>68.088601</td>\n",
              "      <td>0.623814</td>\n",
              "      <td>370.848996</td>\n",
              "      <td>38.922097</td>\n",
              "      <td>54.725661</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>332</th>\n",
              "      <td>cluster</td>\n",
              "      <td>B</td>\n",
              "      <td>3921</td>\n",
              "      <td>251.312772</td>\n",
              "      <td>63158.109491</td>\n",
              "      <td>157.628627</td>\n",
              "      <td>0.578566</td>\n",
              "      <td>131.852813</td>\n",
              "      <td>32.748205</td>\n",
              "      <td>45.735682</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>333</th>\n",
              "      <td>cluster</td>\n",
              "      <td>C</td>\n",
              "      <td>2681</td>\n",
              "      <td>189.050888</td>\n",
              "      <td>35740.238311</td>\n",
              "      <td>94.831700</td>\n",
              "      <td>0.538491</td>\n",
              "      <td>450.645567</td>\n",
              "      <td>42.950930</td>\n",
              "      <td>56.739645</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>334</th>\n",
              "      <td>cluster</td>\n",
              "      <td>undef</td>\n",
              "      <td>2390</td>\n",
              "      <td>110.027433</td>\n",
              "      <td>12106.036072</td>\n",
              "      <td>55.838195</td>\n",
              "      <td>0.405126</td>\n",
              "      <td>224.700111</td>\n",
              "      <td>41.312665</td>\n",
              "      <td>52.887795</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>335</th>\n",
              "      <td>cluster</td>\n",
              "      <td>A</td>\n",
              "      <td>3933</td>\n",
              "      <td>331.123306</td>\n",
              "      <td>109642.643825</td>\n",
              "      <td>251.594122</td>\n",
              "      <td>0.384549</td>\n",
              "      <td>525.171109</td>\n",
              "      <td>25.292889</td>\n",
              "      <td>34.453198</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>336</th>\n",
              "      <td>category</td>\n",
              "      <td>офис</td>\n",
              "      <td>5802</td>\n",
              "      <td>260.883487</td>\n",
              "      <td>68060.193833</td>\n",
              "      <td>165.659868</td>\n",
              "      <td>0.689125</td>\n",
              "      <td>480.500810</td>\n",
              "      <td>32.479390</td>\n",
              "      <td>50.713714</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>337</th>\n",
              "      <td>category</td>\n",
              "      <td>склад</td>\n",
              "      <td>3466</td>\n",
              "      <td>181.937768</td>\n",
              "      <td>33101.351605</td>\n",
              "      <td>84.204224</td>\n",
              "      <td>0.684550</td>\n",
              "      <td>313.998102</td>\n",
              "      <td>40.338706</td>\n",
              "      <td>54.541454</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>338</th>\n",
              "      <td>category</td>\n",
              "      <td>торговля</td>\n",
              "      <td>5239</td>\n",
              "      <td>257.315024</td>\n",
              "      <td>66211.021406</td>\n",
              "      <td>159.558986</td>\n",
              "      <td>0.695902</td>\n",
              "      <td>342.156492</td>\n",
              "      <td>34.884943</td>\n",
              "      <td>49.722807</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>339</th>\n",
              "      <td>category</td>\n",
              "      <td>сельхоз</td>\n",
              "      <td>784</td>\n",
              "      <td>86.217251</td>\n",
              "      <td>7433.414359</td>\n",
              "      <td>27.812762</td>\n",
              "      <td>0.815339</td>\n",
              "      <td>190.286503</td>\n",
              "      <td>26.142557</td>\n",
              "      <td>40.376625</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>340</th>\n",
              "      <td>category</td>\n",
              "      <td>производство</td>\n",
              "      <td>1619</td>\n",
              "      <td>157.173659</td>\n",
              "      <td>24703.559233</td>\n",
              "      <td>63.444690</td>\n",
              "      <td>0.596025</td>\n",
              "      <td>1432.671175</td>\n",
              "      <td>41.429912</td>\n",
              "      <td>55.320562</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>341</th>\n",
              "      <td>category</td>\n",
              "      <td>undef</td>\n",
              "      <td>2381</td>\n",
              "      <td>110.234880</td>\n",
              "      <td>12151.728771</td>\n",
              "      <td>56.034938</td>\n",
              "      <td>0.403792</td>\n",
              "      <td>224.401196</td>\n",
              "      <td>41.306480</td>\n",
              "      <td>52.857003</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>342</th>\n",
              "      <td>category</td>\n",
              "      <td>сто</td>\n",
              "      <td>319</td>\n",
              "      <td>177.668331</td>\n",
              "      <td>31566.036002</td>\n",
              "      <td>65.834418</td>\n",
              "      <td>0.503271</td>\n",
              "      <td>251.273679</td>\n",
              "      <td>41.445692</td>\n",
              "      <td>54.300244</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>343</th>\n",
              "      <td>floors_below</td>\n",
              "      <td>1.0</td>\n",
              "      <td>4665</td>\n",
              "      <td>298.172910</td>\n",
              "      <td>88907.084309</td>\n",
              "      <td>210.334366</td>\n",
              "      <td>0.595626</td>\n",
              "      <td>177.414490</td>\n",
              "      <td>29.232206</td>\n",
              "      <td>41.086018</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>344</th>\n",
              "      <td>floors_below</td>\n",
              "      <td>NaN</td>\n",
              "      <td>14684</td>\n",
              "      <td>184.698415</td>\n",
              "      <td>34113.504600</td>\n",
              "      <td>90.509061</td>\n",
              "      <td>0.702448</td>\n",
              "      <td>538.967285</td>\n",
              "      <td>39.407632</td>\n",
              "      <td>55.061811</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>345</th>\n",
              "      <td>floors_below</td>\n",
              "      <td>2.0</td>\n",
              "      <td>239</td>\n",
              "      <td>300.774166</td>\n",
              "      <td>90465.098869</td>\n",
              "      <td>212.487695</td>\n",
              "      <td>0.535490</td>\n",
              "      <td>37.586650</td>\n",
              "      <td>22.879404</td>\n",
              "      <td>29.143305</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>348</th>\n",
              "      <td>for_clusters_gr</td>\n",
              "      <td>1</td>\n",
              "      <td>11041</td>\n",
              "      <td>259.196362</td>\n",
              "      <td>67182.753896</td>\n",
              "      <td>162.764975</td>\n",
              "      <td>0.693894</td>\n",
              "      <td>414.855861</td>\n",
              "      <td>33.481224</td>\n",
              "      <td>50.243525</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>349</th>\n",
              "      <td>for_clusters_gr</td>\n",
              "      <td>0</td>\n",
              "      <td>6188</td>\n",
              "      <td>166.051190</td>\n",
              "      <td>27572.997641</td>\n",
              "      <td>70.681186</td>\n",
              "      <td>0.677159</td>\n",
              "      <td>587.775206</td>\n",
              "      <td>38.688099</td>\n",
              "      <td>52.938223</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>350</th>\n",
              "      <td>for_clusters_gr</td>\n",
              "      <td>-1</td>\n",
              "      <td>2381</td>\n",
              "      <td>110.234880</td>\n",
              "      <td>12151.728771</td>\n",
              "      <td>56.034938</td>\n",
              "      <td>0.403792</td>\n",
              "      <td>224.401196</td>\n",
              "      <td>41.306480</td>\n",
              "      <td>52.857003</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>351</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>витебская</td>\n",
              "      <td>2350</td>\n",
              "      <td>161.152173</td>\n",
              "      <td>25970.022904</td>\n",
              "      <td>71.298549</td>\n",
              "      <td>0.641847</td>\n",
              "      <td>839.277761</td>\n",
              "      <td>42.080850</td>\n",
              "      <td>61.203907</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>352</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>гомельская</td>\n",
              "      <td>1651</td>\n",
              "      <td>206.100141</td>\n",
              "      <td>42477.268133</td>\n",
              "      <td>100.183947</td>\n",
              "      <td>0.610006</td>\n",
              "      <td>347.181788</td>\n",
              "      <td>40.010518</td>\n",
              "      <td>55.399012</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>353</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>могилевская</td>\n",
              "      <td>1514</td>\n",
              "      <td>186.134263</td>\n",
              "      <td>34645.963779</td>\n",
              "      <td>92.260644</td>\n",
              "      <td>0.558210</td>\n",
              "      <td>709.774677</td>\n",
              "      <td>50.074061</td>\n",
              "      <td>67.130944</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>354</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>минская</td>\n",
              "      <td>3439</td>\n",
              "      <td>193.755680</td>\n",
              "      <td>37541.263510</td>\n",
              "      <td>100.060213</td>\n",
              "      <td>0.676056</td>\n",
              "      <td>444.980154</td>\n",
              "      <td>35.951003</td>\n",
              "      <td>51.028169</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>355</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>брестская</td>\n",
              "      <td>2386</td>\n",
              "      <td>205.608437</td>\n",
              "      <td>42274.829218</td>\n",
              "      <td>103.232409</td>\n",
              "      <td>0.663974</td>\n",
              "      <td>245.523380</td>\n",
              "      <td>38.183847</td>\n",
              "      <td>54.290200</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>356</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>гродненская</td>\n",
              "      <td>1935</td>\n",
              "      <td>186.764499</td>\n",
              "      <td>34880.978112</td>\n",
              "      <td>93.597653</td>\n",
              "      <td>0.725405</td>\n",
              "      <td>212.685504</td>\n",
              "      <td>37.902652</td>\n",
              "      <td>53.532405</td>\n",
              "    </tr>\n",
              "    <tr>\n",
              "      <th>357</th>\n",
              "      <td>oblast_name</td>\n",
              "      <td>-1</td>\n",
              "      <td>6335</td>\n",
              "      <td>269.537125</td>\n",
              "      <td>72650.261773</td>\n",
              "      <td>177.381766</td>\n",
              "      <td>0.709832</td>\n",
              "      <td>411.069465</td>\n",
              "      <td>30.419624</td>\n",
              "      <td>41.457981</td>\n",
              "    </tr>\n",
              "  </tbody>\n",
              "</table>\n",
              "</div>"
            ],
            "text/plain": [
              "         segment_col              segment_val  n_samples        rmse  \\\n",
              "0      property_type     Капитальное строение       9408  165.494025   \n",
              "1      property_type  Изолированное помещение      10202  258.865714   \n",
              "2            Name NP                       -1       7533  146.665056   \n",
              "3            Name NP                   гомель        551  293.061224   \n",
              "4            Name NP                молодечно        168  159.759882   \n",
              "6            Name NP                   полоцк        228  178.754330   \n",
              "8            Name NP                  могилев        480  252.226924   \n",
              "9            Name NP                 бобруйск        329  194.329429   \n",
              "10           Name NP                   гродно        593  266.228220   \n",
              "13           Name NP               барановичи        233  232.012306   \n",
              "16           Name NP                    минск       3961  331.856085   \n",
              "28           Name NP                    брест        611  280.827376   \n",
              "30           Name NP                  городок        110  118.485194   \n",
              "31           Name NP                  борисов        194  262.765068   \n",
              "46           Name NP                     орша        183  172.702757   \n",
              "49           Name NP                    пинск        193  229.114011   \n",
              "50           Name NP                     лида        150  188.447640   \n",
              "54           Name NP                  витебск        547  185.454098   \n",
              "66           Name NP                    слуцк        101   84.568728   \n",
              "197      region_name                 речицкий        191  199.007305   \n",
              "200      region_name                 полоцкий        376  185.411206   \n",
              "202      region_name            барановичский        112  153.121573   \n",
              "204      region_name                       -1       9498  265.093856   \n",
              "205      region_name                  лидский        220  166.153972   \n",
              "206      region_name           молодечненский        236  149.708109   \n",
              "208      region_name                брестский        195  113.134599   \n",
              "211      region_name              солигорский        152  193.106570   \n",
              "212      region_name              гродненский        140  109.990896   \n",
              "213      region_name             осиповичский        139   85.680485   \n",
              "216      region_name                  минский       1151  231.650483   \n",
              "220      region_name                логойский        155  252.037873   \n",
              "227      region_name             дрогичинский        101  171.221626   \n",
              "230      region_name              сморгонский        102  250.578275   \n",
              "233      region_name               жлобинский        231   92.111177   \n",
              "236      region_name              браславский        105  108.365398   \n",
              "237      region_name                вилейский        101  254.071845   \n",
              "240      region_name             смолевичский        159   91.817310   \n",
              "252      region_name              березовский        112  135.600542   \n",
              "255      region_name               пружанский        105  103.791373   \n",
              "256      region_name                оршанский        283  152.776635   \n",
              "257      region_name              дзержинский        175  171.939121   \n",
              "264      region_name              борисовский        293  229.796949   \n",
              "269      region_name                  слуцкий        133   91.127034   \n",
              "271      region_name               слонимский        138  113.030068   \n",
              "282      region_name               г. витебск        547  185.454098   \n",
              "285      region_name                мозырский        138  206.516083   \n",
              "303      region_name               мядельский        108   95.726646   \n",
              "315    wall_material                   Кирпич      10242  192.160047   \n",
              "316    wall_material      Смешанные/каркасные       1065  227.302320   \n",
              "317    wall_material               Деревянные        944  158.013101   \n",
              "318    wall_material                   Панели        685  235.986364   \n",
              "320    wall_material           Блоки (легкие)        920  293.027154   \n",
              "321    wall_material                    Бетон        136  207.636715   \n",
              "322    wall_material                   Металл        506  196.191110   \n",
              "323    wall_material                    Блоки       1931  283.643635   \n",
              "324    wall_material              Другое/Иное       1849  230.064557   \n",
              "326    wall_material              Железобетон       1259  253.658763   \n",
              "329          cluster                        F       1533  118.540531   \n",
              "330          cluster                        E       2952  135.682690   \n",
              "331          cluster                        D       2200  167.619816   \n",
              "332          cluster                        B       3921  251.312772   \n",
              "333          cluster                        C       2681  189.050888   \n",
              "334          cluster                    undef       2390  110.027433   \n",
              "335          cluster                        A       3933  331.123306   \n",
              "336         category                     офис       5802  260.883487   \n",
              "337         category                    склад       3466  181.937768   \n",
              "338         category                 торговля       5239  257.315024   \n",
              "339         category                  сельхоз        784   86.217251   \n",
              "340         category             производство       1619  157.173659   \n",
              "341         category                    undef       2381  110.234880   \n",
              "342         category                      сто        319  177.668331   \n",
              "343     floors_below                      1.0       4665  298.172910   \n",
              "344     floors_below                      NaN      14684  184.698415   \n",
              "345     floors_below                      2.0        239  300.774166   \n",
              "348  for_clusters_gr                        1      11041  259.196362   \n",
              "349  for_clusters_gr                        0       6188  166.051190   \n",
              "350  for_clusters_gr                       -1       2381  110.234880   \n",
              "351      oblast_name                витебская       2350  161.152173   \n",
              "352      oblast_name               гомельская       1651  206.100141   \n",
              "353      oblast_name              могилевская       1514  186.134263   \n",
              "354      oblast_name                  минская       3439  193.755680   \n",
              "355      oblast_name                брестская       2386  205.608437   \n",
              "356      oblast_name              гродненская       1935  186.764499   \n",
              "357      oblast_name                       -1       6335  269.537125   \n",
              "\n",
              "               mse         mae        r2       mape_%  median_mape_%  \\\n",
              "0     27388.272437   69.523836  0.556049   610.877846      45.579856   \n",
              "1     67011.457978  167.986886  0.691775   294.524310      30.164077   \n",
              "2     21510.638536   63.476997  0.703775   442.244857      40.723937   \n",
              "3     85884.881173  190.871640  0.490603   248.099547      39.469551   \n",
              "4     25523.219827   84.450518  0.619302   524.854944      35.477995   \n",
              "6     31953.110391   81.455634  0.522415  1068.362000      50.261404   \n",
              "8     63618.421431  149.258215  0.483775   373.524970      47.429464   \n",
              "9     37763.926811   98.637470  0.368943   312.795390      45.804759   \n",
              "10    70877.465372  180.770387  0.510362   186.851102      29.683203   \n",
              "13    53829.710145  129.151096  0.513537   102.660598      41.449365   \n",
              "16   110128.461472  252.168151  0.380093   521.733514      25.379418   \n",
              "28    78864.015272  185.089161  0.519775    74.186605      33.333520   \n",
              "30    14038.741171   49.059894  0.834349   263.860491      31.560056   \n",
              "31    69045.480701  147.997721  0.350658  1198.437137      51.379054   \n",
              "46    29826.242304   97.340985  0.608672   583.539435      37.538518   \n",
              "49    52493.229947  133.063733  0.397392    87.390162      46.148773   \n",
              "50    35512.512987  102.271253  0.568186    60.917477      36.905726   \n",
              "54    34393.222552  107.229911  0.605319    81.913314      34.766680   \n",
              "66     7151.869814   46.545054  0.655946   262.450916      48.343529   \n",
              "197   39603.907348  114.580966  0.711737   231.385938      40.994708   \n",
              "200   34377.315489   79.021058  0.662685  1001.319259      42.058315   \n",
              "202   23446.216161   52.605000  0.881864   628.993569      48.998463   \n",
              "204   70274.752753  170.536688  0.684791   349.167013      32.923106   \n",
              "205   27607.142530   85.271831  0.598522   176.832568      40.709415   \n",
              "206   22412.517756   74.251513  0.626451   604.850087      45.360496   \n",
              "208   12799.437600   45.497206  0.114480   263.541644      27.318645   \n",
              "211   37290.147490  104.242903  0.671933   297.298572      44.026712   \n",
              "212   12097.997282   59.964908  0.508066   860.729494      45.766736   \n",
              "213    7341.145430   41.959931  0.780013   841.040171      46.890270   \n",
              "216   53661.946302  142.159098  0.650614    61.751264      26.070965   \n",
              "220   63523.089630  128.760515  0.775382   190.077836      27.226533   \n",
              "227   29316.845188   55.271469  0.596891   197.495941      27.760850   \n",
              "230   62789.471905  108.319799  0.615669   119.906192      39.369320   \n",
              "233    8484.468978   29.659786  0.617182   159.556057      13.402117   \n",
              "236   11743.059435   41.792874  0.528324   332.698102      45.092145   \n",
              "237   64552.502243   85.591714  0.507642   669.917289      31.105875   \n",
              "240    8430.418467   45.584840  0.802742    41.911664      31.551699   \n",
              "252   18387.507040   50.679183  0.853314   372.784284      31.877495   \n",
              "255   10772.649158   51.206437  0.605455   588.413919      58.124728   \n",
              "256   23340.700348   75.497612  0.694061   746.207026      38.698937   \n",
              "257   29563.061165   99.363740  0.708312    49.483056      27.984370   \n",
              "264   52806.637880  117.897652  0.387133  1340.209085      50.192360   \n",
              "269    8304.136373   46.967950  0.618046   738.115136      53.947539   \n",
              "271   12775.796282   44.026886  0.567039   344.702666      37.699614   \n",
              "282   34393.222552  107.229911  0.605319    81.913314      34.766680   \n",
              "285   42648.892511   81.343557  0.481844   460.857813      35.036829   \n",
              "303    9163.590760   40.361112  0.449631   375.788865      60.420068   \n",
              "315   36925.483821   95.549100  0.654249   499.321192      41.609103   \n",
              "316   51666.344500  126.897245  0.777948   229.603105      35.109137   \n",
              "317   24968.140091   62.231555  0.720098   521.922937      48.072713   \n",
              "318   55689.563850  139.038115  0.692010   274.682560      30.825598   \n",
              "320   85864.913033  198.416679  0.644236   147.712474      33.985227   \n",
              "321   43113.005417  112.101174  0.804298   120.961629      27.506068   \n",
              "322   38490.951761  107.530228  0.665268   113.589175      36.392148   \n",
              "323   80453.711697  194.215404  0.644474   138.084945      26.220882   \n",
              "324   52929.700348  139.085637  0.762579  1102.866918      27.137543   \n",
              "326   64342.768061  158.613956  0.731210   114.881113      26.379246   \n",
              "329   14051.857402   43.628150  0.735864   610.759922      42.570264   \n",
              "330   18409.792400   52.820790  0.670425   905.151134      47.596120   \n",
              "331   28096.402824   68.088601  0.623814   370.848996      38.922097   \n",
              "332   63158.109491  157.628627  0.578566   131.852813      32.748205   \n",
              "333   35740.238311   94.831700  0.538491   450.645567      42.950930   \n",
              "334   12106.036072   55.838195  0.405126   224.700111      41.312665   \n",
              "335  109642.643825  251.594122  0.384549   525.171109      25.292889   \n",
              "336   68060.193833  165.659868  0.689125   480.500810      32.479390   \n",
              "337   33101.351605   84.204224  0.684550   313.998102      40.338706   \n",
              "338   66211.021406  159.558986  0.695902   342.156492      34.884943   \n",
              "339    7433.414359   27.812762  0.815339   190.286503      26.142557   \n",
              "340   24703.559233   63.444690  0.596025  1432.671175      41.429912   \n",
              "341   12151.728771   56.034938  0.403792   224.401196      41.306480   \n",
              "342   31566.036002   65.834418  0.503271   251.273679      41.445692   \n",
              "343   88907.084309  210.334366  0.595626   177.414490      29.232206   \n",
              "344   34113.504600   90.509061  0.702448   538.967285      39.407632   \n",
              "345   90465.098869  212.487695  0.535490    37.586650      22.879404   \n",
              "348   67182.753896  162.764975  0.693894   414.855861      33.481224   \n",
              "349   27572.997641   70.681186  0.677159   587.775206      38.688099   \n",
              "350   12151.728771   56.034938  0.403792   224.401196      41.306480   \n",
              "351   25970.022904   71.298549  0.641847   839.277761      42.080850   \n",
              "352   42477.268133  100.183947  0.610006   347.181788      40.010518   \n",
              "353   34645.963779   92.260644  0.558210   709.774677      50.074061   \n",
              "354   37541.263510  100.060213  0.676056   444.980154      35.951003   \n",
              "355   42274.829218  103.232409  0.663974   245.523380      38.183847   \n",
              "356   34880.978112   93.597653  0.725405   212.685504      37.902652   \n",
              "357   72650.261773  177.381766  0.709832   411.069465      30.419624   \n",
              "\n",
              "       smape_%  \n",
              "0    62.067040  \n",
              "1    41.584620  \n",
              "2    57.606556  \n",
              "3    54.222497  \n",
              "4    47.812399  \n",
              "6    65.179088  \n",
              "8    61.473018  \n",
              "9    62.122715  \n",
              "10   41.280115  \n",
              "13   53.358417  \n",
              "16   34.585655  \n",
              "28   45.664942  \n",
              "30   45.549539  \n",
              "31   65.931446  \n",
              "46   54.225720  \n",
              "49   56.325724  \n",
              "50   46.944860  \n",
              "54   48.788089  \n",
              "66   53.500591  \n",
              "197  56.639840  \n",
              "200  62.322872  \n",
              "202  75.000758  \n",
              "204  45.681989  \n",
              "205  56.564431  \n",
              "206  61.396704  \n",
              "208  43.721308  \n",
              "211  64.084233  \n",
              "212  65.628976  \n",
              "213  66.145682  \n",
              "216  36.218943  \n",
              "220  43.481838  \n",
              "227  47.184543  \n",
              "230  57.540916  \n",
              "233  34.236539  \n",
              "236  63.090324  \n",
              "237  46.101060  \n",
              "240  38.695148  \n",
              "252  57.047170  \n",
              "255  70.137870  \n",
              "256  59.116240  \n",
              "257  39.176903  \n",
              "264  66.378158  \n",
              "269  60.122827  \n",
              "271  55.932690  \n",
              "282  48.788089  \n",
              "285  49.455871  \n",
              "303  66.904799  \n",
              "315  56.988836  \n",
              "316  49.398956  \n",
              "317  67.274802  \n",
              "318  45.619854  \n",
              "320  47.324875  \n",
              "321  43.686433  \n",
              "322  47.172334  \n",
              "323  38.586075  \n",
              "324  41.231628  \n",
              "326  38.669070  \n",
              "329  63.009194  \n",
              "330  67.015108  \n",
              "331  54.725661  \n",
              "332  45.735682  \n",
              "333  56.739645  \n",
              "334  52.887795  \n",
              "335  34.453198  \n",
              "336  50.713714  \n",
              "337  54.541454  \n",
              "338  49.722807  \n",
              "339  40.376625  \n",
              "340  55.320562  \n",
              "341  52.857003  \n",
              "342  54.300244  \n",
              "343  41.086018  \n",
              "344  55.061811  \n",
              "345  29.143305  \n",
              "348  50.243525  \n",
              "349  52.938223  \n",
              "350  52.857003  \n",
              "351  61.203907  \n",
              "352  55.399012  \n",
              "353  67.130944  \n",
              "354  51.028169  \n",
              "355  54.290200  \n",
              "356  53.532405  \n",
              "357  41.457981  "
            ]
          },
          "execution_count": 53,
          "metadata": {},
          "output_type": "execute_result"
        }
      ],
      "source": [
        "results_df"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "f7920591",
      "metadata": {},
      "outputs": [
        {
          "name": "stderr",
          "output_type": "stream",
          "text": [
            "100%|██████████| 9/9 [00:12<00:00,  1.44s/it]"
          ]
        },
        {
          "name": "stdout",
          "output_type": "stream",
          "text": [
            "Все графики сохранены в папку 'segments_metrics'\n"
          ]
        },
        {
          "name": "stderr",
          "output_type": "stream",
          "text": [
            "\n"
          ]
        }
      ],
      "source": [
        "os.makedirs(\"segments_metrics\", exist_ok=True)\n",
        "\n",
        "metrics = [\"mape_%\", \"median_mape_%\", \"smape_%\"]\n",
        "\n",
        "for segment_col in tqdm(segment_cols):\n",
        "    df_col = results_df[results_df[\"segment_col\"] == segment_col]\n",
        "\n",
        "    # подписи с количеством сэмплов\n",
        "    x_labels = [\n",
        "        f\"{val}\\n(n={df_col[df_col['segment_val'] == val]['n_samples'].iloc[0]})\"\n",
        "        for val in df_col[\"segment_val\"].unique()\n",
        "    ]\n",
        "\n",
        "    unique_vals = df_col[\"segment_val\"].unique()\n",
        "    colors = sns.color_palette(\"tab20\", n_colors=len(unique_vals))\n",
        "    palette = dict(zip(unique_vals, colors))\n",
        "\n",
        "    # Создаем фигуру с subplots: 1 строка, len(metrics) столбцов\n",
        "    fig, axes = plt.subplots(1, len(metrics), figsize=(19 * len(metrics), 8))\n",
        "\n",
        "    # Если метрика одна, то axes будет не массивом, а одним объектом, превращаем в массив\n",
        "    if len(metrics) == 1:\n",
        "        axes = [axes]\n",
        "\n",
        "    for col_idx, metric in enumerate(metrics):\n",
        "        ax = axes[col_idx]\n",
        "        sns.barplot(\n",
        "            data=df_col,\n",
        "            x=\"segment_val\",\n",
        "            y=metric,\n",
        "            hue=\"segment_val\",\n",
        "            palette=palette,\n",
        "            dodge=False,\n",
        "            ax=ax,\n",
        "        )\n",
        "        ax.set_title(f\"{segment_col} – {metric.upper()}\")\n",
        "        ax.set_xticks(np.arange(len(x_labels)))\n",
        "        ax.set_xticklabels(x_labels, rotation=45)\n",
        "\n",
        "    fig.suptitle(f\"Метрики для сегмента {segment_col}\", fontsize=16)\n",
        "    plt.subplots_adjust(top=0.85)\n",
        "\n",
        "    filename = f\"segments_metrics/{segment_col}.png\"\n",
        "plt.savefig(filename, dpi=300, bbox_inches=\"tight\")\n",
        "    plt.close()\n",
        "\n",
        "print(\"Все графики сохранены в папку 'segments_metrics'\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "55e6768a",
      "metadata": {},
      "outputs": [],
      "source": [
        "Y_pred = np.expm1(lgbm_model.predict(X))\n",
        "\n",
        "num_bins = 20\n",
        "bins = pd.qcut(Y_TRUE, q=num_bins, duplicates=\"drop\")\n",
        "\n",
        "df = pd.DataFrame({\"Y_true\": Y_TRUE, \"Y_pred\": Y_pred, \"bin\": bins})\n",
        "\n",
        "\n",
        "def metrics_per_bin(group):\n",
        "    return compute_metrics(group[\"Y_true\"], group[\"Y_pred\"])\n",
        "\n",
        "\n",
        "# получаем метрики с интервалами\n",
        "metrics_by_bin = df.groupby(\"bin\").apply(metrics_per_bin)\n",
        "\n",
        "# выводим с границами\n",
        "for interval, metrics in metrics_by_bin.items():\n",
        "    print(f\"{interval}: {metrics}\")"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "a50348f9",
      "metadata": {},
      "source": [
        "Как и думал, большой выброс MAPE на маленьких значениях\n"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "7c217013",
      "metadata": {},
      "source": [
        "1.  region_name - НАИЛУЧШИЕ ПОКАЗАТЕЛИ\n",
        "    Выдающиеся сегменты:\n",
        "\n",
        "        Смолевичский (n=159): RMSE=74.84, MAE=39.43, MAPE=43.06% - лучший по всем метрикам\n",
        "\n",
        "        Жлобинский (n=230): RMSE=97.40, MAE=31.25, MAPE=130.11% - лучший по MAE\n",
        "\n",
        "        Дзержинский (n=175): MAPE=46.31%, хороший баланс метрик\n",
        "\n",
        "1.  Name NP\n",
        "    Лучшие сегменты:\n",
        "\n",
        "        Городок (n=108): MAPE=58.47%, MAE=56.17 - лучшая относительная точность\n",
        "\n",
        "        Лида (n=150): MAPE=63.50%, сбалансированные показатели\n",
        "\n",
        "        Витебск (n=547): MAPE=94.43%, хорошее качество при большом объеме данных\n",
        "\n",
        "1.  category\n",
        "    Лучшие сегменты:\n",
        "\n",
        "        Сельхоз (n=777): RMSE=98.42, MAE=29.89, MAPE=99.88% - лучший по абсолютным ошибкам\n",
        "\n",
        "        СТО (n=317): хорошие показатели по всем метрикам\n",
        "\n",
        "1.  cluster\n",
        "    Лучшие сегменты:\n",
        "\n",
        "    undef (n=2388): RMSE=111.50, MAE=56.36 - лучшие абсолютные ошибки\n",
        "\n",
        "    F (n=1484): RMSE=120.01, MAE=44.68 - хорошее качество\n",
        "\n",
        "1.  wall_material\n",
        "    Лучшие сегменты:\n",
        "\n",
        "        Панели (n=681): MAPE=81.67%, хороший баланс\n",
        "\n",
        "        Железобетон (n=1252): MAPE=78.51% - лучшая относительная точность\n",
        "\n",
        "1.  oblast_name\n",
        "    Лучшие сегменты:\n",
        "\n",
        "        Брестская (n=2352): сбалансированные показатели\n",
        "\n",
        "        Минская (n=3392): хорошее качество при максимальном объеме данных\n"
      ]
    },
    {
      "cell_type": "markdown",
      "id": "bc9ae99a",
      "metadata": {},
      "source": [
        "# ИТОГОВЫЕ ВЫВОДЫ:\n",
        "\n",
        "## Наиболее перспективные сегменты:\n",
        "\n",
        "Смолевичский район - явный лидер по всем метрикам качества\n",
        "\n",
        "Сельхоз объекты - лучшие по абсолютной точности прогнозирования\n",
        "\n",
        "Городок - лучшая относительная точность среди городов\n",
        "\n",
        "Кластер undef - стабильно высокое качество прогнозов\n",
        "\n",
        "## Сегменты с худшим качеством:\n",
        "\n",
        "Барановичский район (MAPE=501.69%)\n",
        "\n",
        "Гродненский район (MAPE=468.57%)\n",
        "\n",
        "Деревянные строения (MAPE=411.57%)\n",
        "\n",
        "## Рекомендации:\n",
        "\n",
        "Фокус на смолевичский район и сельхоз объекты - здесь модель показывает наилучшие результаты\n",
        "\n",
        "Требуется доработка модели для сегментов с высоким MAPE (>200%)\n",
        "\n",
        "Сегменты с большим объемом данных (Минск, Минская область) демонстрируют стабильное качество\n",
        "\n",
        "Качество прогнозирования существенно варьируется по сегментам, что указывает на необходимость сегментного подхода к оценке и использованию модели.\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "26c921a9",
      "metadata": {},
      "outputs": [],
      "source": []
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "id": "1bb1b2fd",
      "metadata": {},
      "outputs": [],
      "source": []
    }
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.12.7"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}
